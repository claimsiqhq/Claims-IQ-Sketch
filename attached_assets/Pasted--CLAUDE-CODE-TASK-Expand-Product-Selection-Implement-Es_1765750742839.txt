# CLAUDE CODE TASK: Expand Product Selection & Implement Estimate Generation

## Context

This is Claims IQ Sketch â€” a property insurance claims estimation platform built on Replit. The app allows field adjusters to capture property sketches and generate repair estimates.

**Tech Stack:**
- TypeScript/React frontend
- Node.js/Express or Hono backend
- PostgreSQL with Drizzle ORM
- Deployed on Replit

**Current State:**
- Database has `line_items`, `line_item_categories`, and `materials` tables
- Seed data exists for: Fire/Smoke, Insulation, Flooring, Windows/Doors, Plumbing, Electrical, HVAC, Exterior/Siding, Cabinets
- MISSING: Water Mitigation, Drywall, Interior Painting, Roofing line items
- MISSING: Estimate calculation engine and API

---

## PART 1: Audit Existing Schema

First, examine the codebase to understand the current structure:

```bash
# Find and review the database schema
find . -name "schema.ts" -o -name "schema.sql" | head -5
cat db/schema.ts 2>/dev/null || cat shared/schema.ts 2>/dev/null || cat server/db/schema.ts 2>/dev/null

# Find existing seed files
ls -la db/seeds/ 2>/dev/null || ls -la seeds/ 2>/dev/null

# Check for existing estimate-related code
grep -r "estimate" --include="*.ts" --include="*.tsx" -l .

# Check for existing line item API routes
grep -r "line.item" --include="*.ts" -l . | head -10
```

---

## PART 2: Add Missing Categories & Line Items

Create a new seed file: `db/seeds/complete_line_items.sql`

### 2.1 Fix Category Structure

```sql
-- Water Mitigation Categories (01-03)
INSERT INTO line_item_categories (id, parent_id, name, description, sort_order) VALUES
('01', NULL, 'Water Mitigation', 'Water damage mitigation and drying', 1),
('01.1', '01', 'Emergency Services', 'Emergency water extraction', 1),
('01.2', '01', 'Water Extraction', 'Standing water removal', 2),
('01.3', '01', 'Structural Drying', 'Dehumidification and air movement', 3),
('01.4', '01', 'Moisture Monitoring', 'Moisture detection and documentation', 4),
('01.5', '01', 'Content Manipulation', 'Move out, pack out, protection', 5),
('01.6', '01', 'Antimicrobial', 'Antimicrobial treatment and prevention', 6)
ON CONFLICT (id) DO UPDATE SET name = EXCLUDED.name, description = EXCLUDED.description;

-- Demolition Category (02)
INSERT INTO line_item_categories (id, parent_id, name, description, sort_order) VALUES
('02', NULL, 'Demolition & Debris', 'Selective demolition and debris removal', 2),
('02.1', '02', 'Selective Demo', 'Targeted removal of damaged materials', 1),
('02.2', '02', 'Debris Removal', 'Hauling and disposal', 2),
('02.3', '02', 'Containment', 'Dust barriers and protection', 3)
ON CONFLICT (id) DO UPDATE SET name = EXCLUDED.name, description = EXCLUDED.description;

-- Drywall Category (06)
INSERT INTO line_item_categories (id, parent_id, name, description, sort_order) VALUES
('06', NULL, 'Drywall & Walls', 'Drywall installation and repair', 6),
('06.1', '06', 'Drywall Removal', 'Drywall demolition', 1),
('06.2', '06', 'Drywall Installation', 'New drywall hanging', 2),
('06.3', '06', 'Drywall Finishing', 'Tape, mud, and texture', 3),
('06.4', '06', 'Wall Repairs', 'Patching and minor repairs', 4)
ON CONFLICT (id) DO UPDATE SET name = EXCLUDED.name, description = EXCLUDED.description;

-- Interior Painting (14)
INSERT INTO line_item_categories (id, parent_id, name, description, sort_order) VALUES
('14', NULL, 'Interior Painting', 'Interior paint and finishes', 14),
('14.1', '14', 'Wall Painting', 'Interior wall painting', 1),
('14.2', '14', 'Ceiling Painting', 'Ceiling painting', 2),
('14.3', '14', 'Trim Painting', 'Trim, door, and detail painting', 3),
('14.4', '14', 'Primer Application', 'Primer and sealers', 4)
ON CONFLICT (id) DO UPDATE SET name = EXCLUDED.name, description = EXCLUDED.description;

-- Separate Cabinets Category (15) - move from 08
INSERT INTO line_item_categories (id, parent_id, name, description, sort_order) VALUES
('15', NULL, 'Cabinets & Countertops', 'Kitchen and bath cabinetry', 15),
('15.1', '15', 'Base Cabinets', 'Kitchen and bath base cabinets', 1),
('15.2', '15', 'Wall Cabinets', 'Kitchen and bath wall cabinets', 2),
('15.3', '15', 'Countertops', 'All countertop types', 3),
('15.4', '15', 'Cabinet Hardware', 'Pulls, hinges, accessories', 4)
ON CONFLICT (id) DO UPDATE SET name = EXCLUDED.name, description = EXCLUDED.description;
```

### 2.2 Add Missing Materials

```sql
-- Water Mitigation Materials
INSERT INTO materials (id, sku, name, unit, base_price, price_source) VALUES
(gen_random_uuid(), 'DEHU-LGR', 'LGR Dehumidifier rental/day', 'DAY', 85.00, 'baseline_2024'),
(gen_random_uuid(), 'DEHU-CONV', 'Conventional Dehumidifier rental/day', 'DAY', 55.00, 'baseline_2024'),
(gen_random_uuid(), 'AIR-MOVER', 'Air mover rental/day', 'DAY', 35.00, 'baseline_2024'),
(gen_random_uuid(), 'HEPA-AIR', 'HEPA air scrubber rental/day', 'DAY', 95.00, 'baseline_2024'),
(gen_random_uuid(), 'EXTRACTOR', 'Portable extractor rental/day', 'DAY', 75.00, 'baseline_2024'),
(gen_random_uuid(), 'ANTIMICROB', 'Antimicrobial solution gallon', 'GAL', 45.00, 'baseline_2024'),
(gen_random_uuid(), 'PLASTIC-6MIL', 'Plastic sheeting 6mil', 'SF', 0.15, 'baseline_2024'),
(gen_random_uuid(), 'MOISTURE-LOG', 'Moisture documentation', 'EA', 0.00, 'baseline_2024')
ON CONFLICT (sku) DO UPDATE SET base_price = EXCLUDED.base_price;

-- Drywall Materials
INSERT INTO materials (id, sku, name, unit, base_price, price_source) VALUES
(gen_random_uuid(), 'DRY-REG-12', 'Drywall 1/2" regular 4x8', 'EA', 12.50, 'baseline_2024'),
(gen_random_uuid(), 'DRY-REG-58', 'Drywall 5/8" regular 4x8', 'EA', 14.50, 'baseline_2024'),
(gen_random_uuid(), 'DRY-MR-12', 'Drywall 1/2" moisture resistant 4x8', 'EA', 16.00, 'baseline_2024'),
(gen_random_uuid(), 'DRY-MR-58', 'Drywall 5/8" moisture resistant 4x8', 'EA', 18.50, 'baseline_2024'),
(gen_random_uuid(), 'DRY-FIRE-58', 'Drywall 5/8" Type X fire rated 4x8', 'EA', 16.50, 'baseline_2024'),
(gen_random_uuid(), 'DRY-TAPE', 'Drywall tape roll', 'ROLL', 4.50, 'baseline_2024'),
(gen_random_uuid(), 'DRY-MUD', 'Joint compound 5gal bucket', 'EA', 18.00, 'baseline_2024'),
(gen_random_uuid(), 'DRY-SCREW', 'Drywall screws 1lb', 'LB', 8.00, 'baseline_2024'),
(gen_random_uuid(), 'DRY-CORNER', 'Corner bead metal', 'LF', 0.75, 'baseline_2024')
ON CONFLICT (sku) DO UPDATE SET base_price = EXCLUDED.base_price;

-- Interior Paint Materials
INSERT INTO materials (id, sku, name, unit, base_price, price_source) VALUES
(gen_random_uuid(), 'PAINT-INT-FLAT', 'Interior paint flat gallon', 'GAL', 38.00, 'baseline_2024'),
(gen_random_uuid(), 'PAINT-INT-EGG', 'Interior paint eggshell gallon', 'GAL', 42.00, 'baseline_2024'),
(gen_random_uuid(), 'PAINT-INT-SEMI', 'Interior paint semi-gloss gallon', 'GAL', 45.00, 'baseline_2024'),
(gen_random_uuid(), 'PAINT-CEIL', 'Ceiling paint flat gallon', 'GAL', 32.00, 'baseline_2024'),
(gen_random_uuid(), 'PRIMER-INT', 'Interior primer gallon', 'GAL', 28.00, 'baseline_2024'),
(gen_random_uuid(), 'PRIMER-STAIN', 'Stain blocking primer gallon', 'GAL', 48.00, 'baseline_2024')
ON CONFLICT (sku) DO UPDATE SET base_price = EXCLUDED.base_price;

-- Roofing Materials (verify these exist, add if missing)
INSERT INTO materials (id, sku, name, unit, base_price, price_source) VALUES
(gen_random_uuid(), 'SHNG-3TAB-BDL', '3-Tab shingles bundle', 'EA', 32.00, 'baseline_2024'),
(gen_random_uuid(), 'SHNG-ARCH-BDL', 'Architectural shingles bundle', 'EA', 42.00, 'baseline_2024'),
(gen_random_uuid(), 'FELT-SYN', 'Synthetic underlayment roll', 'ROLL', 85.00, 'baseline_2024'),
(gen_random_uuid(), 'ICE-WATER', 'Ice & water shield roll', 'ROLL', 95.00, 'baseline_2024'),
(gen_random_uuid(), 'RIDGE-CAP', 'Ridge cap shingles bundle', 'BDL', 55.00, 'baseline_2024'),
(gen_random_uuid(), 'DRIP-EDGE', 'Drip edge aluminum', 'LF', 1.20, 'baseline_2024'),
(gen_random_uuid(), 'FLASH-STEP', 'Step flashing piece', 'EA', 1.25, 'baseline_2024'),
(gen_random_uuid(), 'VENT-RIDGE', 'Ridge vent', 'LF', 4.50, 'baseline_2024'),
(gen_random_uuid(), 'DECK-OSB', 'Roof deck OSB 7/16"', 'EA', 28.00, 'baseline_2024'),
(gen_random_uuid(), 'NAILS-ROOF', 'Roofing nails coil', 'BOX', 45.00, 'baseline_2024')
ON CONFLICT (sku) DO UPDATE SET base_price = EXCLUDED.base_price;
```

### 2.3 Add Water Mitigation Line Items

```sql
INSERT INTO line_items (id, code, category_id, description, unit, material_components, labor_components, equipment_components, waste_factor, minimum_charge, scope_triggers, related_items, is_active) VALUES

-- Emergency Services
(gen_random_uuid(), 'WTR-EMERG-RESP', '01.1', 'Emergency response - after hours', 'HR', '[]'::jsonb, '[{"task": "emergency_response", "hours_per_unit": 1.0, "trade": "general"}]'::jsonb, '[]'::jsonb, 1.00, 250.00, '[{"damage_type": "water", "severity": "emergency"}]'::jsonb, ARRAY['WTR-EXTRACT-PORT'], true),

(gen_random_uuid(), 'WTR-EMERG-BOARD', '01.1', 'Emergency board up', 'SF', '[{"sku": "PLASTIC-6MIL", "qty_per_unit": 1.1}]'::jsonb, '[{"task": "board_up", "hours_per_unit": 0.05, "trade": "general"}]'::jsonb, '[]'::jsonb, 1.00, 150.00, '[{"damage_type": "water", "severity": "emergency"}]'::jsonb, ARRAY[]::text[], true),

-- Water Extraction
(gen_random_uuid(), 'WTR-EXTRACT-PORT', '01.2', 'Water extraction - portable extractor', 'SF', '[]'::jsonb, '[{"task": "extraction", "hours_per_unit": 0.02, "trade": "general"}]'::jsonb, '[{"type": "portable_extractor", "cost_per_unit": 0.08}]'::jsonb, 1.00, 150.00, '[{"damage_type": "water", "category": 1}, {"damage_type": "water", "category": 2}]'::jsonb, ARRAY['WTR-DRY-SETUP'], true),

(gen_random_uuid(), 'WTR-EXTRACT-TRUCK', '01.2', 'Water extraction - truck mount', 'SF', '[]'::jsonb, '[{"task": "extraction", "hours_per_unit": 0.015, "trade": "general"}]'::jsonb, '[{"type": "truck_mount", "cost_per_unit": 0.12}]'::jsonb, 1.00, 250.00, '[{"damage_type": "water", "severity": "severe"}]'::jsonb, ARRAY['WTR-DRY-SETUP'], true),

(gen_random_uuid(), 'WTR-EXTRACT-SUBFLR', '01.2', 'Water extraction - subfloor/cavity', 'SF', '[]'::jsonb, '[{"task": "extraction", "hours_per_unit": 0.04, "trade": "skilled"}]'::jsonb, '[{"type": "injection_extraction", "cost_per_unit": 0.15}]'::jsonb, 1.00, 200.00, '[{"damage_type": "water", "surface": "subfloor"}]'::jsonb, ARRAY['WTR-DRY-INJECT'], true),

-- Structural Drying
(gen_random_uuid(), 'WTR-DRY-SETUP', '01.3', 'Drying equipment setup', 'EA', '[]'::jsonb, '[{"task": "equipment_setup", "hours_per_unit": 1.0, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.00, 150.00, '[{"damage_type": "water"}]'::jsonb, ARRAY['WTR-DRY-DEHU', 'WTR-DRY-AIrmov'], true),

(gen_random_uuid(), 'WTR-DRY-DEHU', '01.3', 'Dehumidifier - LGR per day', 'DAY', '[]'::jsonb, '[{"task": "monitoring", "hours_per_unit": 0.25, "trade": "general"}]'::jsonb, '[{"type": "lgr_dehumidifier", "cost_per_unit": 85.00}]'::jsonb, 1.00, 85.00, '[{"damage_type": "water"}]'::jsonb, ARRAY['WTR-DRY-AIRMOV'], true),

(gen_random_uuid(), 'WTR-DRY-DEHU-CONV', '01.3', 'Dehumidifier - conventional per day', 'DAY', '[]'::jsonb, '[{"task": "monitoring", "hours_per_unit": 0.25, "trade": "general"}]'::jsonb, '[{"type": "conv_dehumidifier", "cost_per_unit": 55.00}]'::jsonb, 1.00, 55.00, '[{"damage_type": "water", "severity": "minor"}]'::jsonb, ARRAY['WTR-DRY-AIRMOV'], true),

(gen_random_uuid(), 'WTR-DRY-AIRMOV', '01.3', 'Air mover per day', 'DAY', '[]'::jsonb, '[{"task": "monitoring", "hours_per_unit": 0.10, "trade": "general"}]'::jsonb, '[{"type": "air_mover", "cost_per_unit": 35.00}]'::jsonb, 1.00, 35.00, '[{"damage_type": "water"}]'::jsonb, ARRAY['WTR-DRY-DEHU'], true),

(gen_random_uuid(), 'WTR-DRY-HEPA', '01.3', 'HEPA air scrubber per day', 'DAY', '[]'::jsonb, '[{"task": "monitoring", "hours_per_unit": 0.15, "trade": "general"}]'::jsonb, '[{"type": "hepa_scrubber", "cost_per_unit": 95.00}]'::jsonb, 1.00, 95.00, '[{"damage_type": "water", "category": 3}]'::jsonb, ARRAY['WTR-ANTIMICROB'], true),

(gen_random_uuid(), 'WTR-DRY-INJECT', '01.3', 'Injection drying system per day', 'DAY', '[]'::jsonb, '[{"task": "monitoring", "hours_per_unit": 0.25, "trade": "skilled"}]'::jsonb, '[{"type": "injection_system", "cost_per_unit": 125.00}]'::jsonb, 1.00, 125.00, '[{"damage_type": "water", "surface": "wall_cavity"}]'::jsonb, ARRAY['DRY-HOLE-DRILL'], true),

-- Moisture Monitoring
(gen_random_uuid(), 'WTR-MOIST-INIT', '01.4', 'Initial moisture inspection/mapping', 'SF', '[]'::jsonb, '[{"task": "moisture_inspection", "hours_per_unit": 0.02, "trade": "skilled"}]'::jsonb, '[{"type": "moisture_meter", "cost_per_unit": 0.05}]'::jsonb, 1.00, 150.00, '[{"damage_type": "water"}]'::jsonb, ARRAY['WTR-MOIST-DAILY'], true),

(gen_random_uuid(), 'WTR-MOIST-DAILY', '01.4', 'Daily moisture monitoring', 'DAY', '[]'::jsonb, '[{"task": "moisture_monitoring", "hours_per_unit": 1.0, "trade": "skilled"}]'::jsonb, '[{"type": "moisture_meter", "cost_per_unit": 15.00}]'::jsonb, 1.00, 95.00, '[{"damage_type": "water"}]'::jsonb, ARRAY['WTR-MOIST-LOG'], true),

(gen_random_uuid(), 'WTR-MOIST-LOG', '01.4', 'Moisture documentation/psychrometric log', 'EA', '[]'::jsonb, '[{"task": "documentation", "hours_per_unit": 0.5, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.00, 45.00, '[{"damage_type": "water"}]'::jsonb, ARRAY[]::text[], true),

-- Content Manipulation
(gen_random_uuid(), 'WTR-CONTENT-MOVE', '01.5', 'Content move out - per room', 'EA', '[{"sku": "PLASTIC-6MIL", "qty_per_unit": 50}]'::jsonb, '[{"task": "content_move", "hours_per_unit": 2.0, "trade": "general"}]'::jsonb, '[]'::jsonb, 1.00, 175.00, '[{"damage_type": "water", "surface": "contents"}]'::jsonb, ARRAY['WTR-CONTENT-BACK'], true),

(gen_random_uuid(), 'WTR-CONTENT-BACK', '01.5', 'Content move back - per room', 'EA', '[]'::jsonb, '[{"task": "content_move", "hours_per_unit": 1.5, "trade": "general"}]'::jsonb, '[]'::jsonb, 1.00, 125.00, '[]'::jsonb, ARRAY[]::text[], true),

(gen_random_uuid(), 'WTR-CONTENT-BLOCK', '01.5', 'Block and protect contents', 'SF', '[{"sku": "PLASTIC-6MIL", "qty_per_unit": 1.0}]'::jsonb, '[{"task": "content_protect", "hours_per_unit": 0.03, "trade": "general"}]'::jsonb, '[]'::jsonb, 1.00, 75.00, '[{"damage_type": "water"}]'::jsonb, ARRAY[]::text[], true),

-- Antimicrobial
(gen_random_uuid(), 'WTR-ANTIMICROB', '01.6', 'Antimicrobial treatment - surfaces', 'SF', '[{"sku": "ANTIMICROB", "qty_per_unit": 0.005}]'::jsonb, '[{"task": "antimicrobial_apply", "hours_per_unit": 0.02, "trade": "skilled"}]'::jsonb, '[{"type": "sprayer", "cost_per_unit": 0.03}]'::jsonb, 1.00, 100.00, '[{"damage_type": "water", "category": 2}, {"damage_type": "water", "category": 3}]'::jsonb, ARRAY['WTR-DRY-HEPA'], true),

(gen_random_uuid(), 'WTR-ANTIMICROB-CAV', '01.6', 'Antimicrobial treatment - wall cavity', 'SF', '[{"sku": "ANTIMICROB", "qty_per_unit": 0.008}]'::jsonb, '[{"task": "antimicrobial_inject", "hours_per_unit": 0.04, "trade": "skilled"}]'::jsonb, '[{"type": "injection_equip", "cost_per_unit": 0.05}]'::jsonb, 1.00, 125.00, '[{"damage_type": "water", "category": 3, "surface": "wall_cavity"}]'::jsonb, ARRAY['DRY-HOLE-DRILL'], true);
```

### 2.4 Add Demolition Line Items

```sql
INSERT INTO line_items (id, code, category_id, description, unit, material_components, labor_components, equipment_components, waste_factor, minimum_charge, scope_triggers, related_items, is_active) VALUES

-- Selective Demo
(gen_random_uuid(), 'DEM-DRY-FLOOD', '02.1', 'Drywall removal - flood cut 2ft', 'LF', '[]'::jsonb, '[{"task": "demolition", "hours_per_unit": 0.08, "trade": "general"}]'::jsonb, '[]'::jsonb, 1.00, 50.00, '[{"damage_type": "water", "surface": "wall"}]'::jsonb, ARRAY['DRY-HTT-12', 'WTR-ANTIMICROB'], true),

(gen_random_uuid(), 'DEM-DRY-FULL', '02.1', 'Drywall removal - full height', 'SF', '[]'::jsonb, '[{"task": "demolition", "hours_per_unit": 0.03, "trade": "general"}]'::jsonb, '[]'::jsonb, 1.00, 75.00, '[{"damage_type": "fire", "surface": "wall"}, {"damage_type": "water", "severity": "severe"}]'::jsonb, ARRAY['DRY-HTT-12'], true),

(gen_random_uuid(), 'DEM-DRY-CEIL', '02.1', 'Ceiling drywall removal', 'SF', '[]'::jsonb, '[{"task": "demolition", "hours_per_unit": 0.04, "trade": "general"}]'::jsonb, '[{"type": "scaffolding", "cost_per_unit": 0.05}]'::jsonb, 1.00, 100.00, '[{"damage_type": "water", "surface": "ceiling"}]'::jsonb, ARRAY['DRY-HTT-CEIL'], true),

(gen_random_uuid(), 'DEM-INSUL', '02.1', 'Insulation removal - wet/contaminated', 'SF', '[]'::jsonb, '[{"task": "demolition", "hours_per_unit": 0.03, "trade": "general"}]'::jsonb, '[{"type": "disposal_bags", "cost_per_unit": 0.10}]'::jsonb, 1.00, 50.00, '[{"damage_type": "water", "surface": "insulation"}]'::jsonb, ARRAY['INSUL-BATT-R13'], true),

(gen_random_uuid(), 'DEM-BASE', '02.1', 'Baseboard removal', 'LF', '[]'::jsonb, '[{"task": "demolition", "hours_per_unit": 0.03, "trade": "general"}]'::jsonb, '[]'::jsonb, 1.00, 25.00, '[{"damage_type": "water", "surface": "trim"}]'::jsonb, ARRAY['TRIM-BASE'], true),

(gen_random_uuid(), 'DEM-FLOOR-VNL', '02.1', 'Vinyl/LVP flooring removal', 'SF', '[]'::jsonb, '[{"task": "demolition", "hours_per_unit": 0.02, "trade": "general"}]'::jsonb, '[]'::jsonb, 1.00, 50.00, '[{"damage_type": "water", "surface": "floor"}]'::jsonb, ARRAY['FLR-LAM-STD'], true),

(gen_random_uuid(), 'DEM-FLOOR-TILE', '02.1', 'Ceramic tile flooring removal', 'SF', '[]'::jsonb, '[{"task": "demolition", "hours_per_unit": 0.06, "trade": "general"}]'::jsonb, '[{"type": "tile_removal_equip", "cost_per_unit": 0.05}]'::jsonb, 1.00, 100.00, '[{"damage_type": "water", "surface": "tile"}]'::jsonb, ARRAY['FLR-TILE-CER'], true),

(gen_random_uuid(), 'DEM-FLOOR-CARPET', '02.1', 'Carpet and pad removal', 'SF', '[]'::jsonb, '[{"task": "demolition", "hours_per_unit": 0.015, "trade": "general"}]'::jsonb, '[]'::jsonb, 1.00, 50.00, '[{"damage_type": "water", "surface": "carpet"}]'::jsonb, ARRAY['FLR-CARPET'], true),

-- Debris Removal
(gen_random_uuid(), 'DEM-HAUL', '02.2', 'Debris haul off - per load', 'EA', '[]'::jsonb, '[{"task": "hauling", "hours_per_unit": 2.0, "trade": "general"}]'::jsonb, '[{"type": "dump_fees", "cost_per_unit": 85.00}]'::jsonb, 1.00, 250.00, '[]'::jsonb, ARRAY[]::text[], true),

(gen_random_uuid(), 'DEM-DUMPSTER', '02.2', 'Dumpster rental - 20yd', 'DAY', '[]'::jsonb, '[]'::jsonb, '[{"type": "dumpster_rental", "cost_per_unit": 125.00}]'::jsonb, 1.00, 125.00, '[]'::jsonb, ARRAY[]::text[], true),

-- Containment
(gen_random_uuid(), 'DEM-CONTAIN', '02.3', 'Dust containment barrier', 'SF', '[{"sku": "PLASTIC-6MIL", "qty_per_unit": 1.0}]'::jsonb, '[{"task": "containment_setup", "hours_per_unit": 0.05, "trade": "general"}]'::jsonb, '[]'::jsonb, 1.10, 75.00, '[{"damage_type": "fire"}, {"damage_type": "water", "category": 3}]'::jsonb, ARRAY['WTR-DRY-HEPA'], true),

(gen_random_uuid(), 'DEM-FLOOR-PROT', '02.3', 'Floor protection', 'SF', '[{"sku": "PLASTIC-6MIL", "qty_per_unit": 1.0}]'::jsonb, '[{"task": "floor_protection", "hours_per_unit": 0.01, "trade": "general"}]'::jsonb, '[]'::jsonb, 1.00, 50.00, '[]'::jsonb, ARRAY[]::text[], true);
```

### 2.5 Add Drywall Line Items

```sql
INSERT INTO line_items (id, code, category_id, description, unit, material_components, labor_components, equipment_components, waste_factor, minimum_charge, scope_triggers, related_items, is_active) VALUES

-- Drywall Installation
(gen_random_uuid(), 'DRY-HTT-12', '06.2', 'Drywall 1/2" hang, tape, texture - walls', 'SF', '[{"sku": "DRY-REG-12", "qty_per_unit": 0.03125}, {"sku": "DRY-TAPE", "qty_per_unit": 0.01}, {"sku": "DRY-MUD", "qty_per_unit": 0.005}, {"sku": "DRY-SCREW", "qty_per_unit": 0.02}]'::jsonb, '[{"task": "hang", "hours_per_unit": 0.03, "trade": "skilled"}, {"task": "tape", "hours_per_unit": 0.02, "trade": "skilled"}, {"task": "texture", "hours_per_unit": 0.015, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.10, 150.00, '[{"damage_type": "water", "surface": "wall"}, {"damage_type": "fire", "surface": "wall"}]'::jsonb, ARRAY['PAINT-INT-WALL', 'INSUL-BATT-R13'], true),

(gen_random_uuid(), 'DRY-HTT-58', '06.2', 'Drywall 5/8" hang, tape, texture - walls', 'SF', '[{"sku": "DRY-REG-58", "qty_per_unit": 0.03125}, {"sku": "DRY-TAPE", "qty_per_unit": 0.01}, {"sku": "DRY-MUD", "qty_per_unit": 0.006}, {"sku": "DRY-SCREW", "qty_per_unit": 0.02}]'::jsonb, '[{"task": "hang", "hours_per_unit": 0.035, "trade": "skilled"}, {"task": "tape", "hours_per_unit": 0.02, "trade": "skilled"}, {"task": "texture", "hours_per_unit": 0.015, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.10, 175.00, '[{"damage_type": "fire", "surface": "wall"}]'::jsonb, ARRAY['PAINT-INT-WALL'], true),

(gen_random_uuid(), 'DRY-HTT-MR', '06.2', 'Drywall 1/2" moisture resistant - HTT', 'SF', '[{"sku": "DRY-MR-12", "qty_per_unit": 0.03125}, {"sku": "DRY-TAPE", "qty_per_unit": 0.01}, {"sku": "DRY-MUD", "qty_per_unit": 0.005}, {"sku": "DRY-SCREW", "qty_per_unit": 0.02}]'::jsonb, '[{"task": "hang", "hours_per_unit": 0.03, "trade": "skilled"}, {"task": "tape", "hours_per_unit": 0.02, "trade": "skilled"}, {"task": "texture", "hours_per_unit": 0.015, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.10, 175.00, '[{"damage_type": "water", "surface": "bathroom"}]'::jsonb, ARRAY['PAINT-INT-WALL'], true),

(gen_random_uuid(), 'DRY-HTT-CEIL', '06.2', 'Drywall 1/2" ceiling - HTT', 'SF', '[{"sku": "DRY-REG-12", "qty_per_unit": 0.03125}, {"sku": "DRY-TAPE", "qty_per_unit": 0.01}, {"sku": "DRY-MUD", "qty_per_unit": 0.005}, {"sku": "DRY-SCREW", "qty_per_unit": 0.02}]'::jsonb, '[{"task": "hang", "hours_per_unit": 0.045, "trade": "skilled"}, {"task": "tape", "hours_per_unit": 0.025, "trade": "skilled"}, {"task": "texture", "hours_per_unit": 0.02, "trade": "skilled"}]'::jsonb, '[{"type": "scaffolding", "cost_per_unit": 0.08}]'::jsonb, 1.10, 200.00, '[{"damage_type": "water", "surface": "ceiling"}]'::jsonb, ARRAY['PAINT-INT-CEIL'], true),

(gen_random_uuid(), 'DRY-FIRE-58', '06.2', 'Drywall 5/8" Type X fire rated - HTT', 'SF', '[{"sku": "DRY-FIRE-58", "qty_per_unit": 0.03125}, {"sku": "DRY-TAPE", "qty_per_unit": 0.01}, {"sku": "DRY-MUD", "qty_per_unit": 0.006}, {"sku": "DRY-SCREW", "qty_per_unit": 0.02}]'::jsonb, '[{"task": "hang", "hours_per_unit": 0.035, "trade": "skilled"}, {"task": "tape", "hours_per_unit": 0.02, "trade": "skilled"}, {"task": "texture", "hours_per_unit": 0.015, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.10, 185.00, '[{"damage_type": "fire", "surface": "garage"}]'::jsonb, ARRAY['PAINT-INT-WALL'], true),

-- Drywall Finishing
(gen_random_uuid(), 'DRY-TAPE-ONLY', '06.3', 'Drywall tape and finish only', 'SF', '[{"sku": "DRY-TAPE", "qty_per_unit": 0.01}, {"sku": "DRY-MUD", "qty_per_unit": 0.004}]'::jsonb, '[{"task": "tape", "hours_per_unit": 0.025, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.00, 100.00, '[]'::jsonb, ARRAY['DRY-TEXT-MATCH'], true),

(gen_random_uuid(), 'DRY-TEXT-MATCH', '06.3', 'Texture match - knockdown/orange peel', 'SF', '[{"sku": "DRY-MUD", "qty_per_unit": 0.002}]'::jsonb, '[{"task": "texture", "hours_per_unit": 0.03, "trade": "specialty"}]'::jsonb, '[{"type": "texture_gun", "cost_per_unit": 0.05}]'::jsonb, 1.00, 125.00, '[]'::jsonb, ARRAY['PAINT-INT-WALL'], true),

(gen_random_uuid(), 'DRY-TEXT-SMOOTH', '06.3', 'Skim coat - smooth finish', 'SF', '[{"sku": "DRY-MUD", "qty_per_unit": 0.003}]'::jsonb, '[{"task": "skim_coat", "hours_per_unit": 0.04, "trade": "specialty"}]'::jsonb, '[]'::jsonb, 1.00, 150.00, '[]'::jsonb, ARRAY['PAINT-INT-WALL'], true),

-- Repairs
(gen_random_uuid(), 'DRY-PATCH-SM', '06.4', 'Drywall patch repair - small (<2 SF)', 'EA', '[{"sku": "DRY-MUD", "qty_per_unit": 0.25}]'::jsonb, '[{"task": "patch", "hours_per_unit": 0.5, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.00, 75.00, '[{"damage_type": "impact", "surface": "wall"}]'::jsonb, ARRAY['PAINT-INT-WALL'], true),

(gen_random_uuid(), 'DRY-PATCH-MED', '06.4', 'Drywall patch repair - medium (2-6 SF)', 'EA', '[{"sku": "DRY-REG-12", "qty_per_unit": 0.125}, {"sku": "DRY-MUD", "qty_per_unit": 0.5}]'::jsonb, '[{"task": "patch", "hours_per_unit": 1.0, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.00, 125.00, '[{"damage_type": "impact", "surface": "wall"}]'::jsonb, ARRAY['PAINT-INT-WALL'], true),

(gen_random_uuid(), 'DRY-HOLE-DRILL', '06.4', 'Drill inspection/injection holes', 'EA', '[]'::jsonb, '[{"task": "drill", "hours_per_unit": 0.1, "trade": "general"}]'::jsonb, '[]'::jsonb, 1.00, 15.00, '[{"damage_type": "water", "surface": "wall_cavity"}]'::jsonb, ARRAY['WTR-DRY-INJECT'], true),

(gen_random_uuid(), 'DRY-CORNER', '06.4', 'Corner bead - replace', 'LF', '[{"sku": "DRY-CORNER", "qty_per_unit": 1.0}, {"sku": "DRY-MUD", "qty_per_unit": 0.02}]'::jsonb, '[{"task": "install", "hours_per_unit": 0.08, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.05, 35.00, '[{"damage_type": "impact", "surface": "corner"}]'::jsonb, ARRAY['DRY-TAPE-ONLY'], true);
```

### 2.6 Add Interior Painting Line Items

```sql
INSERT INTO line_items (id, code, category_id, description, unit, material_components, labor_components, equipment_components, waste_factor, minimum_charge, scope_triggers, related_items, is_active) VALUES

-- Wall Painting
(gen_random_uuid(), 'PAINT-INT-WALL', '14.1', 'Interior wall paint - 2 coats', 'SF', '[{"sku": "PAINT-INT-EGG", "qty_per_unit": 0.003}]'::jsonb, '[{"task": "prep", "hours_per_unit": 0.01, "trade": "general"}, {"task": "paint", "hours_per_unit": 0.02, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.10, 125.00, '[{"damage_type": "water", "surface": "wall"}, {"damage_type": "fire", "surface": "wall"}, {"damage_type": "smoke", "surface": "wall"}]'::jsonb, ARRAY['PAINT-INT-PRIME'], true),

(gen_random_uuid(), 'PAINT-INT-WALL-1', '14.1', 'Interior wall paint - 1 coat', 'SF', '[{"sku": "PAINT-INT-EGG", "qty_per_unit": 0.0015}]'::jsonb, '[{"task": "paint", "hours_per_unit": 0.012, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.10, 100.00, '[]'::jsonb, ARRAY[]::text[], true),

(gen_random_uuid(), 'PAINT-INT-WALL-SEMI', '14.1', 'Interior wall paint semi-gloss - 2 coats', 'SF', '[{"sku": "PAINT-INT-SEMI", "qty_per_unit": 0.003}]'::jsonb, '[{"task": "prep", "hours_per_unit": 0.01, "trade": "general"}, {"task": "paint", "hours_per_unit": 0.022, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.10, 135.00, '[{"damage_type": "water", "surface": "bathroom"}]'::jsonb, ARRAY['PAINT-INT-PRIME'], true),

-- Ceiling Painting
(gen_random_uuid(), 'PAINT-INT-CEIL', '14.2', 'Ceiling paint - 2 coats', 'SF', '[{"sku": "PAINT-CEIL", "qty_per_unit": 0.003}]'::jsonb, '[{"task": "prep", "hours_per_unit": 0.01, "trade": "general"}, {"task": "paint", "hours_per_unit": 0.025, "trade": "skilled"}]'::jsonb, '[{"type": "scaffolding", "cost_per_unit": 0.03}]'::jsonb, 1.10, 150.00, '[{"damage_type": "water", "surface": "ceiling"}, {"damage_type": "smoke", "surface": "ceiling"}]'::jsonb, ARRAY['PAINT-INT-PRIME-STAIN'], true),

(gen_random_uuid(), 'PAINT-INT-CEIL-1', '14.2', 'Ceiling paint - 1 coat', 'SF', '[{"sku": "PAINT-CEIL", "qty_per_unit": 0.0015}]'::jsonb, '[{"task": "paint", "hours_per_unit": 0.015, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.10, 100.00, '[]'::jsonb, ARRAY[]::text[], true),

-- Trim Painting  
(gen_random_uuid(), 'PAINT-INT-TRIM', '14.3', 'Trim/baseboard paint - 2 coats', 'LF', '[{"sku": "PAINT-INT-SEMI", "qty_per_unit": 0.002}]'::jsonb, '[{"task": "prep", "hours_per_unit": 0.02, "trade": "general"}, {"task": "paint", "hours_per_unit": 0.04, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.10, 75.00, '[{"damage_type": "water", "surface": "trim"}]'::jsonb, ARRAY[]::text[], true),

(gen_random_uuid(), 'PAINT-DOOR', '14.3', 'Interior door paint - both sides', 'EA', '[{"sku": "PAINT-INT-SEMI", "qty_per_unit": 0.15}]'::jsonb, '[{"task": "prep", "hours_per_unit": 0.25, "trade": "general"}, {"task": "paint", "hours_per_unit": 0.75, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.00, 85.00, '[{"damage_type": "water", "surface": "door"}, {"damage_type": "smoke", "surface": "door"}]'::jsonb, ARRAY[]::text[], true),

(gen_random_uuid(), 'PAINT-DOOR-FRAME', '14.3', 'Door frame/jamb paint', 'EA', '[{"sku": "PAINT-INT-SEMI", "qty_per_unit": 0.05}]'::jsonb, '[{"task": "paint", "hours_per_unit": 0.35, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.00, 55.00, '[]'::jsonb, ARRAY['PAINT-DOOR'], true),

-- Primer
(gen_random_uuid(), 'PAINT-INT-PRIME', '14.4', 'Interior primer - walls', 'SF', '[{"sku": "PRIMER-INT", "qty_per_unit": 0.0025}]'::jsonb, '[{"task": "prime", "hours_per_unit": 0.012, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.10, 75.00, '[]'::jsonb, ARRAY['PAINT-INT-WALL'], true),

(gen_random_uuid(), 'PAINT-INT-PRIME-STAIN', '14.4', 'Stain blocking primer', 'SF', '[{"sku": "PRIMER-STAIN", "qty_per_unit": 0.003}]'::jsonb, '[{"task": "prime", "hours_per_unit": 0.015, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.10, 100.00, '[{"damage_type": "water", "surface": "ceiling"}, {"damage_type": "smoke"}]'::jsonb, ARRAY['PAINT-INT-CEIL'], true);
```

### 2.7 Add Roofing Line Items

```sql
INSERT INTO line_items (id, code, category_id, description, unit, material_components, labor_components, equipment_components, waste_factor, minimum_charge, scope_triggers, related_items, is_active) VALUES

-- Shingle Roofing
(gen_random_uuid(), 'ROOF-3TAB', '12.1', '3-Tab shingles - remove & replace', 'SQ', '[{"sku": "SHNG-3TAB-BDL", "qty_per_unit": 3.0}, {"sku": "FELT-SYN", "qty_per_unit": 0.4}, {"sku": "NAILS-ROOF", "qty_per_unit": 0.05}, {"sku": "DRIP-EDGE", "qty_per_unit": 4.0}]'::jsonb, '[{"task": "tear_off", "hours_per_unit": 0.75, "trade": "general"}, {"task": "install", "hours_per_unit": 1.25, "trade": "skilled"}]'::jsonb, '[{"type": "ladder_scaffolding", "cost_per_unit": 15.00}, {"type": "debris_container", "cost_per_unit": 20.00}]'::jsonb, 1.10, 350.00, '[{"damage_type": "wind", "surface": "roof"}, {"damage_type": "hail", "surface": "roof"}]'::jsonb, ARRAY['ROOF-FELT', 'ROOF-DRIP'], true),

(gen_random_uuid(), 'ROOF-ARCH', '12.1', 'Architectural shingles - remove & replace', 'SQ', '[{"sku": "SHNG-ARCH-BDL", "qty_per_unit": 3.0}, {"sku": "FELT-SYN", "qty_per_unit": 0.4}, {"sku": "NAILS-ROOF", "qty_per_unit": 0.05}, {"sku": "DRIP-EDGE", "qty_per_unit": 4.0}]'::jsonb, '[{"task": "tear_off", "hours_per_unit": 0.75, "trade": "general"}, {"task": "install", "hours_per_unit": 1.5, "trade": "skilled"}]'::jsonb, '[{"type": "ladder_scaffolding", "cost_per_unit": 15.00}, {"type": "debris_container", "cost_per_unit": 25.00}]'::jsonb, 1.10, 450.00, '[{"damage_type": "wind", "surface": "roof"}, {"damage_type": "hail", "surface": "roof"}]'::jsonb, ARRAY['ROOF-FELT', 'ROOF-DRIP', 'ROOF-RIDGE'], true),

(gen_random_uuid(), 'ROOF-RIDGE', '12.1', 'Ridge cap shingles', 'LF', '[{"sku": "RIDGE-CAP", "qty_per_unit": 0.04}]'::jsonb, '[{"task": "install", "hours_per_unit": 0.05, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.05, 75.00, '[{"damage_type": "wind", "surface": "roof"}]'::jsonb, ARRAY['ROOF-VENT-RIDGE'], true),

(gen_random_uuid(), 'ROOF-STARTER', '12.1', 'Starter strip shingles', 'LF', '[{"sku": "SHNG-ARCH-BDL", "qty_per_unit": 0.015}]'::jsonb, '[{"task": "install", "hours_per_unit": 0.02, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.05, 50.00, '[]'::jsonb, ARRAY['ROOF-ARCH'], true),

-- Underlayment
(gen_random_uuid(), 'ROOF-FELT', '12.2', 'Synthetic underlayment', 'SQ', '[{"sku": "FELT-SYN", "qty_per_unit": 0.5}]'::jsonb, '[{"task": "install", "hours_per_unit": 0.15, "trade": "general"}]'::jsonb, '[]'::jsonb, 1.10, 50.00, '[]'::jsonb, ARRAY['ROOF-ARCH'], true),

(gen_random_uuid(), 'ROOF-ICE', '12.2', 'Ice & water shield', 'SQ', '[{"sku": "ICE-WATER", "qty_per_unit": 0.5}]'::jsonb, '[{"task": "install", "hours_per_unit": 0.20, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.05, 75.00, '[{"damage_type": "ice_dam", "surface": "roof"}]'::jsonb, ARRAY['ROOF-ARCH'], true),

-- Flashing
(gen_random_uuid(), 'ROOF-FLASH-STEP', '12.3', 'Step flashing - chimney/wall', 'LF', '[{"sku": "FLASH-STEP", "qty_per_unit": 1.33}]'::jsonb, '[{"task": "install", "hours_per_unit": 0.15, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.10, 75.00, '[{"damage_type": "leak", "surface": "flashing"}]'::jsonb, ARRAY[]::text[], true),

(gen_random_uuid(), 'ROOF-FLASH-VALLEY', '12.3', 'Valley flashing', 'LF', '[{"sku": "FLASH-STEP", "qty_per_unit": 1.0}]'::jsonb, '[{"task": "install", "hours_per_unit": 0.12, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.10, 65.00, '[{"damage_type": "leak", "surface": "valley"}]'::jsonb, ARRAY[]::text[], true),

(gen_random_uuid(), 'ROOF-DRIP', '12.3', 'Drip edge', 'LF', '[{"sku": "DRIP-EDGE", "qty_per_unit": 1.0}]'::jsonb, '[{"task": "install", "hours_per_unit": 0.03, "trade": "general"}]'::jsonb, '[]'::jsonb, 1.05, 35.00, '[]'::jsonb, ARRAY['ROOF-ARCH'], true),

-- Ventilation
(gen_random_uuid(), 'ROOF-VENT-RIDGE', '12.4', 'Ridge vent', 'LF', '[{"sku": "VENT-RIDGE", "qty_per_unit": 1.0}]'::jsonb, '[{"task": "install", "hours_per_unit": 0.08, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.05, 75.00, '[]'::jsonb, ARRAY['ROOF-RIDGE'], true),

(gen_random_uuid(), 'ROOF-VENT-BOX', '12.4', 'Box/static vent', 'EA', '[{"sku": "VENT-BOX", "qty_per_unit": 1.0}]'::jsonb, '[{"task": "install", "hours_per_unit": 0.5, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.00, 85.00, '[{"damage_type": "wind", "surface": "vent"}]'::jsonb, ARRAY[]::text[], true),

-- Decking
(gen_random_uuid(), 'ROOF-DECK', '12.7', 'Roof decking OSB - replace', 'SF', '[{"sku": "DECK-OSB", "qty_per_unit": 0.03125}]'::jsonb, '[{"task": "remove", "hours_per_unit": 0.02, "trade": "general"}, {"task": "install", "hours_per_unit": 0.03, "trade": "skilled"}]'::jsonb, '[]'::jsonb, 1.10, 100.00, '[{"damage_type": "rot", "surface": "roof_deck"}, {"damage_type": "water", "surface": "roof_deck"}]'::jsonb, ARRAY['ROOF-ARCH'], true),

-- Gutters
(gen_random_uuid(), 'ROOF-GUTTER', '12.5', 'Aluminum gutter 5" - remove & replace', 'LF', '[{"sku": "GUTTER-ALUM", "qty_per_unit": 1.0}, {"sku": "GUTTER-HANGER", "qty_per_unit": 0.33}]'::jsonb, '[{"task": "remove", "hours_per_unit": 0.03, "trade": "general"}, {"task": "install", "hours_per_unit": 0.08, "trade": "skilled"}]'::jsonb, '[{"type": "ladder", "cost_per_unit": 0.25}]'::jsonb, 1.05, 100.00, '[{"damage_type": "wind", "surface": "gutter"}, {"damage_type": "ice", "surface": "gutter"}]'::jsonb, ARRAY['ROOF-DOWNSPOUT'], true),

(gen_random_uuid(), 'ROOF-DOWNSPOUT', '12.5', 'Downspout 2x3" - remove & replace', 'LF', '[{"sku": "DOWNSPOUT", "qty_per_unit": 1.0}]'::jsonb, '[{"task": "remove", "hours_per_unit": 0.03, "trade": "general"}, {"task": "install", "hours_per_unit": 0.06, "trade": "general"}]'::jsonb, '[]'::jsonb, 1.05, 50.00, '[{"damage_type": "wind", "surface": "gutter"}]'::jsonb, ARRAY['ROOF-GUTTER'], true);
```

---

## PART 3: Add Support Tables for Estimate Generation

### 3.1 Labor Rates Table

```sql
-- Create labor_rates table if not exists
CREATE TABLE IF NOT EXISTS labor_rates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    trade VARCHAR(50) NOT NULL UNIQUE,
    description VARCHAR(200),
    base_hourly_rate DECIMAL(8,2) NOT NULL,
    overtime_multiplier DECIMAL(4,2) DEFAULT 1.5,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Seed labor rates
INSERT INTO labor_rates (trade, description, base_hourly_rate) VALUES
('general', 'General laborer - demolition, cleanup, basic tasks', 35.00),
('skilled', 'Skilled tradesperson - drywall, painting, flooring', 55.00),
('specialty', 'Specialty trade - texture matching, tile, hardwood', 75.00),
('electrical', 'Licensed electrician', 85.00),
('plumbing', 'Licensed plumber', 85.00),
('hvac', 'HVAC technician', 80.00)
ON CONFLICT (trade) DO UPDATE SET base_hourly_rate = EXCLUDED.base_hourly_rate;
```

### 3.2 Regional Multipliers Table

```sql
-- Create regional_multipliers table if not exists
CREATE TABLE IF NOT EXISTS regional_multipliers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    region_code VARCHAR(20) NOT NULL UNIQUE,
    region_name VARCHAR(100),
    state VARCHAR(2),
    material_multiplier DECIMAL(5,3) DEFAULT 1.000,
    labor_multiplier DECIMAL(5,3) DEFAULT 1.000,
    equipment_multiplier DECIMAL(5,3) DEFAULT 1.000,
    effective_date DATE DEFAULT CURRENT_DATE,
    is_active BOOLEAN DEFAULT true
);

-- Seed some regional multipliers (expand as needed)
INSERT INTO regional_multipliers (region_code, region_name, state, material_multiplier, labor_multiplier) VALUES
('US-NATL', 'National Average', NULL, 1.000, 1.000),
('US-TX-DFW', 'Dallas-Fort Worth TX', 'TX', 0.95, 0.90),
('US-TX-HOU', 'Houston TX', 'TX', 0.97, 0.92),
('US-TX-AUS', 'Austin TX', 'TX', 1.02, 0.95),
('US-CA-LA', 'Los Angeles CA', 'CA', 1.15, 1.35),
('US-CA-SF', 'San Francisco CA', 'CA', 1.20, 1.45),
('US-NY-NYC', 'New York City NY', 'NY', 1.25, 1.50),
('US-FL-MIA', 'Miami FL', 'FL', 1.05, 0.95),
('US-FL-ORL', 'Orlando FL', 'FL', 0.98, 0.90),
('US-CO-DEN', 'Denver CO', 'CO', 1.05, 1.05),
('US-IL-CHI', 'Chicago IL', 'IL', 1.10, 1.20),
('US-WA-SEA', 'Seattle WA', 'WA', 1.12, 1.25)
ON CONFLICT (region_code) DO UPDATE SET 
    material_multiplier = EXCLUDED.material_multiplier,
    labor_multiplier = EXCLUDED.labor_multiplier;
```

### 3.3 Carrier Profiles Table

```sql
-- Create carrier_profiles table if not exists
CREATE TABLE IF NOT EXISTS carrier_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    code VARCHAR(20) UNIQUE,
    
    -- O&P Settings
    overhead_pct DECIMAL(5,2) DEFAULT 10.00,
    profit_pct DECIMAL(5,2) DEFAULT 10.00,
    apply_op_threshold DECIMAL(10,2) DEFAULT 0, -- Apply O&P when estimate exceeds this
    
    -- Tax Settings
    applies_tax BOOLEAN DEFAULT false,
    tax_rate DECIMAL(6,4) DEFAULT 0,
    tax_on_materials_only BOOLEAN DEFAULT true,
    
    -- Pricing Rules
    use_program_pricing BOOLEAN DEFAULT false,
    program_pricing_url TEXT,
    
    -- Audit Requirements
    requires_photos BOOLEAN DEFAULT true,
    requires_moisture_readings BOOLEAN DEFAULT true,
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Seed some carrier profiles
INSERT INTO carrier_profiles (name, code, overhead_pct, profit_pct, applies_tax, requires_photos) VALUES
('Default Profile', 'DEFAULT', 10.00, 10.00, false, true),
('State Farm', 'STATEFARM', 10.00, 10.00, false, true),
('Allstate', 'ALLSTATE', 10.00, 10.00, false, true),
('USAA', 'USAA', 10.00, 10.00, false, true),
('Farmers', 'FARMERS', 10.00, 10.00, false, true),
('Liberty Mutual', 'LIBERTY', 10.00, 10.00, false, true)
ON CONFLICT (code) DO UPDATE SET name = EXCLUDED.name;
```

---

## PART 4: Implement Estimate Calculation Engine

Create the estimate calculation service. Look for existing estimate-related files first:

```bash
find . -name "*estimate*" -type f | head -10
```

Then create or update the estimate calculation logic:

### 4.1 Create `/server/services/estimateCalculator.ts`

```typescript
import { db } from '../db';
import { eq, inArray } from 'drizzle-orm';
import { 
  lineItems, 
  materials, 
  laborRates, 
  regionalMultipliers,
  carrierProfiles,
  estimates,
  estimateLineItems 
} from '../db/schema';

interface EstimateLineItemInput {
  lineItemCode: string;
  quantity: number;
  notes?: string;
  damageZoneId?: string;
}

interface EstimateCalculationInput {
  claimId: string;
  lineItems: EstimateLineItemInput[];
  regionCode?: string;
  carrierProfileId?: string;
}

interface CalculatedLineItem {
  code: string;
  description: string;
  categoryId: string;
  unit: string;
  quantity: number;
  materialCost: number;
  laborCost: number;
  equipmentCost: number;
  unitPrice: number;
  subtotal: number;
  notes?: string;
}

interface EstimateResult {
  lineItems: CalculatedLineItem[];
  subtotal: number;
  overheadAmount: number;
  overheadPct: number;
  profitAmount: number;
  profitPct: number;
  taxAmount: number;
  taxPct: number;
  grandTotal: number;
  regionCode: string;
  carrierProfileId?: string;
}

export async function calculateEstimate(input: EstimateCalculationInput): Promise<EstimateResult> {
  const regionCode = input.regionCode || 'US-NATL';
  
  // Fetch regional multipliers
  const [region] = await db
    .select()
    .from(regionalMultipliers)
    .where(eq(regionalMultipliers.regionCode, regionCode))
    .limit(1);
  
  const materialMultiplier = region?.materialMultiplier || 1.0;
  const laborMultiplier = region?.laborMultiplier || 1.0;
  const equipmentMultiplier = region?.equipmentMultiplier || 1.0;
  
  // Fetch carrier profile
  let carrierProfile = null;
  if (input.carrierProfileId) {
    [carrierProfile] = await db
      .select()
      .from(carrierProfiles)
      .where(eq(carrierProfiles.id, input.carrierProfileId))
      .limit(1);
  }
  
  // Fetch all labor rates
  const laborRatesList = await db.select().from(laborRates);
  const laborRatesMap = new Map(laborRatesList.map(lr => [lr.trade, lr.baseHourlyRate]));
  
  // Fetch line item definitions
  const lineItemCodes = input.lineItems.map(li => li.lineItemCode);
  const lineItemDefs = await db
    .select()
    .from(lineItems)
    .where(inArray(lineItems.code, lineItemCodes));
  
  const lineItemMap = new Map(lineItemDefs.map(li => [li.code, li]));
  
  // Fetch all materials
  const materialSkus = new Set<string>();
  lineItemDefs.forEach(li => {
    const components = li.materialComponents as Array<{sku: string; qty_per_unit: number}>;
    components?.forEach(c => materialSkus.add(c.sku));
  });
  
  const materialsList = await db
    .select()
    .from(materials)
    .where(inArray(materials.sku, Array.from(materialSkus)));
  
  const materialsMap = new Map(materialsList.map(m => [m.sku, m.basePrice]));
  
  // Calculate each line item
  const calculatedItems: CalculatedLineItem[] = [];
  
  for (const inputItem of input.lineItems) {
    const def = lineItemMap.get(inputItem.lineItemCode);
    if (!def) continue;
    
    const quantity = inputItem.quantity;
    
    // Calculate material cost
    let materialCost = 0;
    const matComponents = def.materialComponents as Array<{sku: string; qty_per_unit: number}>;
    matComponents?.forEach(comp => {
      const basePrice = materialsMap.get(comp.sku) || 0;
      materialCost += Number(basePrice) * comp.qty_per_unit * quantity * Number(materialMultiplier);
    });
    
    // Apply waste factor
    materialCost *= Number(def.wasteFactor || 1.0);
    
    // Calculate labor cost
    let laborCost = 0;
    const laborComponents = def.laborComponents as Array<{task: string; hours_per_unit: number; trade: string}>;
    laborComponents?.forEach(comp => {
      const hourlyRate = laborRatesMap.get(comp.trade) || 45;
      laborCost += Number(hourlyRate) * comp.hours_per_unit * quantity * Number(laborMultiplier);
    });
    
    // Calculate equipment cost
    let equipmentCost = 0;
    const equipComponents = def.equipmentComponents as Array<{type: string; cost_per_unit: number}>;
    equipComponents?.forEach(comp => {
      equipmentCost += comp.cost_per_unit * quantity * Number(equipmentMultiplier);
    });
    
    // Calculate totals
    const unitPrice = (materialCost + laborCost + equipmentCost) / quantity;
    let subtotal = materialCost + laborCost + equipmentCost;
    
    // Apply minimum charge
    if (subtotal < Number(def.minimumCharge || 0)) {
      subtotal = Number(def.minimumCharge);
    }
    
    calculatedItems.push({
      code: def.code,
      description: def.description,
      categoryId: def.categoryId,
      unit: def.unit,
      quantity,
      materialCost: Math.round(materialCost * 100) / 100,
      laborCost: Math.round(laborCost * 100) / 100,
      equipmentCost: Math.round(equipmentCost * 100) / 100,
      unitPrice: Math.round(unitPrice * 100) / 100,
      subtotal: Math.round(subtotal * 100) / 100,
      notes: inputItem.notes,
    });
  }
  
  // Calculate totals
  const subtotal = calculatedItems.reduce((sum, item) => sum + item.subtotal, 0);
  
  // O&P Calculation
  const overheadPct = carrierProfile?.overheadPct || 10;
  const profitPct = carrierProfile?.profitPct || 10;
  const opThreshold = carrierProfile?.applyOpThreshold || 0;
  
  let overheadAmount = 0;
  let profitAmount = 0;
  
  if (subtotal >= Number(opThreshold)) {
    overheadAmount = subtotal * (Number(overheadPct) / 100);
    profitAmount = subtotal * (Number(profitPct) / 100);
  }
  
  // Tax calculation (if applicable)
  const taxPct = carrierProfile?.appliesTax ? Number(carrierProfile.taxRate || 0) : 0;
  const taxableAmount = carrierProfile?.taxOnMaterialsOnly 
    ? calculatedItems.reduce((sum, item) => sum + item.materialCost, 0)
    : subtotal;
  const taxAmount = taxableAmount * (taxPct / 100);
  
  const grandTotal = subtotal + overheadAmount + profitAmount + taxAmount;
  
  return {
    lineItems: calculatedItems,
    subtotal: Math.round(subtotal * 100) / 100,
    overheadAmount: Math.round(overheadAmount * 100) / 100,
    overheadPct: Number(overheadPct),
    profitAmount: Math.round(profitAmount * 100) / 100,
    profitPct: Number(profitPct),
    taxAmount: Math.round(taxAmount * 100) / 100,
    taxPct,
    grandTotal: Math.round(grandTotal * 100) / 100,
    regionCode,
    carrierProfileId: input.carrierProfileId,
  };
}

export async function saveEstimate(
  claimId: string, 
  calculation: EstimateResult
): Promise<string> {
  // Create estimate record
  const [estimate] = await db
    .insert(estimates)
    .values({
      claimId,
      status: 'draft',
      subtotal: calculation.subtotal.toString(),
      overheadAmount: calculation.overheadAmount.toString(),
      overheadPct: calculation.overheadPct.toString(),
      profitAmount: calculation.profitAmount.toString(),
      profitPct: calculation.profitPct.toString(),
      taxAmount: calculation.taxAmount.toString(),
      taxPct: calculation.taxPct.toString(),
      grandTotal: calculation.grandTotal.toString(),
      regionId: calculation.regionCode,
      carrierProfileId: calculation.carrierProfileId,
    })
    .returning();
  
  // Create line item records
  for (let i = 0; i < calculation.lineItems.length; i++) {
    const item = calculation.lineItems[i];
    await db.insert(estimateLineItems).values({
      estimateId: estimate.id,
      lineItemCode: item.code,
      lineItemDescription: item.description,
      categoryId: item.categoryId,
      quantity: item.quantity.toString(),
      unit: item.unit,
      unitPrice: item.unitPrice.toString(),
      materialCost: item.materialCost.toString(),
      laborCost: item.laborCost.toString(),
      equipmentCost: item.equipmentCost.toString(),
      subtotal: item.subtotal.toString(),
      source: 'manual',
      notes: item.notes,
      sortOrder: i,
    });
  }
  
  return estimate.id;
}
```

### 4.2 Create API Routes

Add to your routes file (find existing routes first):

```typescript
// GET /api/line-items - Search line items
app.get('/api/line-items', async (c) => {
  const query = c.req.query('q') || '';
  const categoryId = c.req.query('category');
  const limit = parseInt(c.req.query('limit') || '50');
  
  let queryBuilder = db.select().from(lineItems).where(eq(lineItems.isActive, true));
  
  if (query) {
    queryBuilder = queryBuilder.where(
      or(
        ilike(lineItems.code, `%${query}%`),
        ilike(lineItems.description, `%${query}%`)
      )
    );
  }
  
  if (categoryId) {
    queryBuilder = queryBuilder.where(
      or(
        eq(lineItems.categoryId, categoryId),
        like(lineItems.categoryId, `${categoryId}.%`)
      )
    );
  }
  
  const results = await queryBuilder.limit(limit);
  return c.json(results);
});

// GET /api/line-item-categories - Get all categories
app.get('/api/line-item-categories', async (c) => {
  const categories = await db.select().from(lineItemCategories).orderBy(lineItemCategories.sortOrder);
  return c.json(categories);
});

// POST /api/estimates/calculate - Calculate estimate without saving
app.post('/api/estimates/calculate', async (c) => {
  const body = await c.req.json();
  const result = await calculateEstimate(body);
  return c.json(result);
});

// POST /api/estimates - Calculate and save estimate
app.post('/api/estimates', async (c) => {
  const body = await c.req.json();
  const calculation = await calculateEstimate(body);
  const estimateId = await saveEstimate(body.claimId, calculation);
  return c.json({ id: estimateId, ...calculation });
});

// GET /api/estimates/:id - Get estimate by ID
app.get('/api/estimates/:id', async (c) => {
  const id = c.req.param('id');
  
  const [estimate] = await db
    .select()
    .from(estimates)
    .where(eq(estimates.id, id))
    .limit(1);
  
  if (!estimate) {
    return c.json({ error: 'Estimate not found' }, 404);
  }
  
  const items = await db
    .select()
    .from(estimateLineItems)
    .where(eq(estimateLineItems.estimateId, id))
    .orderBy(estimateLineItems.sortOrder);
  
  return c.json({ ...estimate, lineItems: items });
});

// GET /api/regions - Get regional multipliers
app.get('/api/regions', async (c) => {
  const regions = await db
    .select()
    .from(regionalMultipliers)
    .where(eq(regionalMultipliers.isActive, true));
  return c.json(regions);
});

// GET /api/carrier-profiles - Get carrier profiles
app.get('/api/carrier-profiles', async (c) => {
  const profiles = await db
    .select()
    .from(carrierProfiles)
    .where(eq(carrierProfiles.isActive, true));
  return c.json(profiles);
});
```

---

## PART 5: Update Drizzle Schema

Ensure your schema includes all necessary tables. Check existing schema first:

```bash
cat shared/schema.ts 2>/dev/null || cat db/schema.ts 2>/dev/null
```

Add any missing table definitions to match the SQL tables created above.

---

## PART 6: Run Migrations and Seeds

After creating all files:

```bash
# Generate Drizzle migrations if using Drizzle Kit
npx drizzle-kit generate

# Push schema changes
npx drizzle-kit push

# Or run SQL seeds directly
psql $DATABASE_URL -f db/seeds/complete_line_items.sql
```

---

## Success Criteria

1. **Line Items**: 150+ line items covering Water Mitigation, Drywall, Interior Painting, Roofing, plus existing categories

2. **Estimate Calculation**: 
   - Material + Labor + Equipment costs calculated correctly
   - Regional multipliers applied
   - O&P calculated based on carrier profile
   - Minimum charges enforced

3. **API Endpoints Working**:
   - `GET /api/line-items` - search/filter line items
   - `GET /api/line-item-categories` - category tree
   - `POST /api/estimates/calculate` - preview estimate
   - `POST /api/estimates` - save estimate
   - `GET /api/estimates/:id` - retrieve estimate

4. **Database**: All support tables created (labor_rates, regional_multipliers, carrier_profiles)

---

## Next Steps After Completion

1. **PDF Generation** - Add ReportLab/WeasyPrint for estimate PDFs
2. **ESX Export** - Xactimate compatibility 
3. **AI Scope Suggestions** - Auto-suggest line items from damage zones
4. **Voice Integration** - Connect to the OpenAI voice agent for voice-driven estimation