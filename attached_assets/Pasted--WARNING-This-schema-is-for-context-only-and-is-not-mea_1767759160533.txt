-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.ai_prompts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  prompt_key character varying NOT NULL UNIQUE,
  prompt_name character varying NOT NULL,
  category character varying NOT NULL,
  system_prompt text NOT NULL,
  user_prompt_template text,
  model character varying NOT NULL DEFAULT 'gpt-4o'::character varying,
  temperature numeric DEFAULT 0.3,
  max_tokens integer,
  response_format character varying DEFAULT 'text'::character varying,
  description text,
  version integer DEFAULT 1,
  is_active boolean DEFAULT true,
  usage_count integer DEFAULT 0,
  last_used_at timestamp without time zone,
  avg_tokens_used integer,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT ai_prompts_pkey PRIMARY KEY (id)
);
CREATE TABLE public.carrier_excluded_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  carrier_profile_id uuid NOT NULL,
  line_item_code character varying NOT NULL,
  exclusion_reason text NOT NULL,
  carrier_reference character varying,
  effective_date date DEFAULT CURRENT_DATE,
  expiration_date date,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT carrier_excluded_items_pkey PRIMARY KEY (id)
);
CREATE TABLE public.carrier_item_caps (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  carrier_profile_id uuid NOT NULL,
  line_item_code character varying,
  category_id character varying,
  max_quantity numeric,
  max_quantity_per_zone numeric,
  max_unit_price numeric,
  max_total_cost numeric,
  cap_reason text,
  carrier_reference character varying,
  effective_date date DEFAULT CURRENT_DATE,
  expiration_date date,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT carrier_item_caps_pkey PRIMARY KEY (id)
);
CREATE TABLE public.carrier_profiles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code character varying NOT NULL UNIQUE,
  name character varying NOT NULL,
  display_name character varying,
  carrier_type character varying NOT NULL DEFAULT 'national'::character varying,
  strictness_level character varying NOT NULL DEFAULT 'standard'::character varying,
  op_threshold numeric DEFAULT 2500.00,
  op_trade_minimum integer DEFAULT 3,
  op_pct_overhead numeric DEFAULT 10.00,
  op_pct_profit numeric DEFAULT 10.00,
  tax_on_materials_only boolean DEFAULT false,
  tax_on_labor boolean DEFAULT true,
  tax_on_equipment boolean DEFAULT false,
  depreciation_method character varying DEFAULT 'straight_line'::character varying,
  max_depreciation_pct numeric DEFAULT 80.00,
  default_depreciation_recoverable boolean DEFAULT true,
  requires_photos_all_rooms boolean DEFAULT false,
  requires_moisture_readings boolean DEFAULT false,
  requires_itemized_invoice boolean DEFAULT true,
  rule_config jsonb DEFAULT '{}'::jsonb,
  carrier_inspection_overlays jsonb DEFAULT '{}'::jsonb,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT carrier_profiles_pkey PRIMARY KEY (id)
);
CREATE TABLE public.carrier_rules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  carrier_profile_id uuid NOT NULL,
  rule_code character varying NOT NULL,
  rule_name character varying NOT NULL,
  rule_type character varying NOT NULL,
  target_type character varying NOT NULL,
  target_value character varying,
  conditions jsonb DEFAULT '{}'::jsonb,
  effect_type character varying NOT NULL,
  effect_value jsonb NOT NULL,
  explanation_template text,
  carrier_reference character varying,
  effective_date date DEFAULT CURRENT_DATE,
  expiration_date date,
  priority integer DEFAULT 100,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT carrier_rules_pkey PRIMARY KEY (id)
);
CREATE TABLE public.claim_briefings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  claim_id uuid NOT NULL,
  peril character varying NOT NULL,
  secondary_perils jsonb DEFAULT '[]'::jsonb,
  source_hash character varying NOT NULL,
  briefing_json jsonb NOT NULL,
  status character varying NOT NULL DEFAULT 'generated'::character varying,
  model character varying,
  prompt_tokens integer,
  completion_tokens integer,
  total_tokens integer,
  error_message text,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT claim_briefings_pkey PRIMARY KEY (id),
  CONSTRAINT fk_claim_briefings_org FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT fk_claim_briefings_claim FOREIGN KEY (claim_id) REFERENCES public.claims(id)
);
CREATE TABLE public.claim_checklist_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  checklist_id uuid NOT NULL,
  item_code character varying NOT NULL,
  item_name character varying NOT NULL,
  category character varying,
  status character varying DEFAULT 'pending'::character varying,
  completed_at timestamp without time zone,
  completed_by character varying,
  notes text,
  sort_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  title character varying NOT NULL DEFAULT ''::character varying,
  description text,
  required_for_perils jsonb DEFAULT '[]'::jsonb,
  required_for_severities jsonb DEFAULT '[]'::jsonb,
  conditional_logic jsonb DEFAULT '{}'::jsonb,
  required boolean DEFAULT true,
  priority integer DEFAULT 1,
  skipped_reason text,
  linked_document_ids jsonb DEFAULT '[]'::jsonb,
  due_date timestamp without time zone,
  CONSTRAINT claim_checklist_items_pkey PRIMARY KEY (id),
  CONSTRAINT claim_checklist_items_checklist_id_fkey FOREIGN KEY (checklist_id) REFERENCES public.claim_checklists(id)
);
CREATE TABLE public.claim_checklists (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  claim_id uuid NOT NULL,
  template_id uuid,
  name character varying NOT NULL,
  status character varying DEFAULT 'in_progress'::character varying,
  completed_at timestamp without time zone,
  created_by character varying,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  organization_id uuid,
  description text,
  peril character varying NOT NULL DEFAULT 'other'::character varying,
  severity character varying NOT NULL DEFAULT 'moderate'::character varying,
  template_version character varying DEFAULT '1.0'::character varying,
  total_items integer NOT NULL DEFAULT 0,
  completed_items integer NOT NULL DEFAULT 0,
  metadata jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT claim_checklists_pkey PRIMARY KEY (id),
  CONSTRAINT claim_checklists_claim_id_fkey FOREIGN KEY (claim_id) REFERENCES public.claims(id),
  CONSTRAINT fk_claim_checklists_claim FOREIGN KEY (claim_id) REFERENCES public.claims(id),
  CONSTRAINT fk_claim_checklists_org FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.claim_damage_zones (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  claim_id uuid NOT NULL,
  room_id uuid,
  organization_id uuid NOT NULL,
  damage_type character varying NOT NULL,
  category character varying,
  associated_peril character varying,
  peril_confidence numeric,
  affected_walls jsonb DEFAULT '[]'::jsonb,
  floor_affected boolean DEFAULT false,
  ceiling_affected boolean DEFAULT false,
  extent_ft numeric DEFAULT '0'::numeric,
  severity character varying,
  source character varying,
  polygon jsonb DEFAULT '[]'::jsonb,
  is_freeform boolean DEFAULT false,
  notes text,
  sort_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT claim_damage_zones_pkey PRIMARY KEY (id),
  CONSTRAINT fk_claim_damage_zones_claim FOREIGN KEY (claim_id) REFERENCES public.claims(id),
  CONSTRAINT fk_claim_damage_zones_org FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT fk_claim_damage_zones_room FOREIGN KEY (room_id) REFERENCES public.claim_rooms(id)
);
CREATE TABLE public.claim_photos (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  claim_id uuid,
  organization_id uuid NOT NULL,
  structure_id uuid,
  room_id uuid,
  damage_zone_id uuid,
  storage_path character varying NOT NULL,
  public_url character varying NOT NULL,
  file_name character varying NOT NULL,
  mime_type character varying NOT NULL,
  file_size integer,
  label character varying,
  hierarchy_path character varying,
  description text,
  ai_analysis jsonb DEFAULT '{}'::jsonb,
  quality_score integer,
  damage_detected boolean DEFAULT false,
  captured_at timestamp without time zone DEFAULT now(),
  analyzed_at timestamp without time zone,
  uploaded_by character varying,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  latitude double precision,
  longitude double precision,
  geo_address character varying,
  analysis_status character varying DEFAULT 'pending'::character varying,
  analysis_error text,
  CONSTRAINT claim_photos_pkey PRIMARY KEY (id),
  CONSTRAINT fk_claim_photos_claim FOREIGN KEY (claim_id) REFERENCES public.claims(id),
  CONSTRAINT fk_claim_photos_org FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT fk_claim_photos_structure FOREIGN KEY (structure_id) REFERENCES public.claim_structures(id),
  CONSTRAINT fk_claim_photos_room FOREIGN KEY (room_id) REFERENCES public.claim_rooms(id),
  CONSTRAINT fk_claim_photos_zone FOREIGN KEY (damage_zone_id) REFERENCES public.claim_damage_zones(id)
);
CREATE TABLE public.claim_rooms (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  claim_id uuid NOT NULL,
  organization_id uuid NOT NULL,
  name character varying NOT NULL,
  room_type character varying,
  floor_level character varying DEFAULT '1'::character varying,
  shape character varying NOT NULL DEFAULT 'rectangular'::character varying,
  width_ft numeric NOT NULL,
  length_ft numeric NOT NULL,
  ceiling_height_ft numeric DEFAULT 8.0,
  origin_x_ft numeric DEFAULT '0'::numeric,
  origin_y_ft numeric DEFAULT '0'::numeric,
  polygon jsonb DEFAULT '[]'::jsonb,
  l_shape_config jsonb,
  t_shape_config jsonb,
  openings jsonb DEFAULT '[]'::jsonb,
  features jsonb DEFAULT '[]'::jsonb,
  notes jsonb DEFAULT '[]'::jsonb,
  sort_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  structure_id uuid,
  CONSTRAINT claim_rooms_pkey PRIMARY KEY (id),
  CONSTRAINT fk_claim_rooms_claim FOREIGN KEY (claim_id) REFERENCES public.claims(id),
  CONSTRAINT fk_claim_rooms_org FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT fk_claim_rooms_structure FOREIGN KEY (structure_id) REFERENCES public.claim_structures(id)
);
CREATE TABLE public.claim_structures (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  claim_id uuid NOT NULL,
  organization_id uuid NOT NULL,
  name character varying NOT NULL,
  structure_type character varying NOT NULL,
  description text,
  address text,
  stories integer DEFAULT 1,
  year_built integer,
  construction_type character varying,
  roof_type character varying,
  photos jsonb DEFAULT '[]'::jsonb,
  notes jsonb DEFAULT '[]'::jsonb,
  sort_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT claim_structures_pkey PRIMARY KEY (id),
  CONSTRAINT fk_claim_structures_claim FOREIGN KEY (claim_id) REFERENCES public.claims(id),
  CONSTRAINT fk_claim_structures_org FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.claims (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  assigned_user_id uuid,
  claim_id character varying NOT NULL,
  carrier_id uuid,
  region_id character varying,
  insured_name character varying,
  insured_email character varying,
  insured_phone character varying,
  property_address text,
  property_city character varying,
  property_state character varying,
  property_zip character varying,
  property_latitude numeric,
  property_longitude numeric,
  geocode_status character varying,
  geocoded_at timestamp without time zone,
  date_of_loss date,
  loss_type character varying,
  loss_description text,
  primary_peril character varying,
  secondary_perils jsonb DEFAULT '[]'::jsonb,
  peril_confidence numeric,
  peril_metadata jsonb DEFAULT '{}'::jsonb,
  policy_number character varying,
  claim_type character varying,
  dwelling_limit character varying,
  endorsements_listed jsonb DEFAULT '[]'::jsonb,
  coverage_a numeric,
  coverage_b numeric,
  coverage_c numeric,
  coverage_d numeric,
  deductible numeric,
  status character varying NOT NULL DEFAULT 'draft'::character varying,
  assigned_adjuster_id uuid,
  total_rcv numeric DEFAULT '0'::numeric,
  total_acv numeric DEFAULT '0'::numeric,
  total_paid numeric DEFAULT '0'::numeric,
  pricing_snapshot jsonb DEFAULT '{}'::jsonb,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  closed_at timestamp without time zone,
  loss_context jsonb NOT NULL DEFAULT '{}'::jsonb,
  claim_number character varying,
  raw_openai_response jsonb,
  peril_specific_deductibles jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT claims_pkey PRIMARY KEY (id)
);
CREATE TABLE public.coverage_types (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code character varying NOT NULL UNIQUE,
  name character varying NOT NULL,
  description text,
  default_deductible numeric DEFAULT '0'::numeric,
  sort_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  CONSTRAINT coverage_types_pkey PRIMARY KEY (id)
);
CREATE TABLE public.damage_areas (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  estimate_id uuid NOT NULL,
  parent_area_id uuid,
  sketch_zone_id uuid,
  name character varying NOT NULL,
  area_type character varying NOT NULL,
  measurements jsonb DEFAULT '{}'::jsonb,
  photo_ids jsonb DEFAULT '[]'::jsonb,
  sort_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT damage_areas_pkey PRIMARY KEY (id)
);
CREATE TABLE public.damage_zones (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  estimate_id uuid NOT NULL,
  name character varying NOT NULL,
  room_type character varying,
  floor_level character varying,
  length_ft numeric,
  width_ft numeric,
  height_ft numeric DEFAULT 8.0,
  square_footage numeric,
  damage_type character varying,
  damage_severity character varying,
  water_category integer,
  water_class integer,
  associated_peril character varying,
  peril_confidence numeric,
  affected_surfaces jsonb DEFAULT '[]'::jsonb,
  notes text,
  sort_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT damage_zones_pkey PRIMARY KEY (id)
);
CREATE TABLE public.depreciation_schedules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  category_code character varying NOT NULL,
  item_type character varying NOT NULL,
  useful_life_years integer NOT NULL,
  max_depreciation_pct numeric DEFAULT 80.00,
  depreciation_method character varying DEFAULT 'straight_line'::character varying,
  condition_adjustment_good numeric DEFAULT 0.85,
  condition_adjustment_poor numeric DEFAULT 1.15,
  is_depreciable boolean DEFAULT true,
  notes text,
  CONSTRAINT depreciation_schedules_pkey PRIMARY KEY (id)
);
CREATE TABLE public.documents (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  claim_id uuid,
  name character varying NOT NULL,
  type character varying NOT NULL,
  category character varying,
  file_name character varying NOT NULL,
  file_size integer NOT NULL,
  mime_type character varying NOT NULL,
  storage_path character varying NOT NULL,
  extracted_data jsonb DEFAULT '{}'::jsonb,
  processing_status character varying DEFAULT 'pending'::character varying,
  full_text text,
  page_texts jsonb DEFAULT '[]'::jsonb,
  description text,
  tags jsonb DEFAULT '[]'::jsonb,
  uploaded_by character varying,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  page_count integer,
  preview_status character varying DEFAULT 'pending'::character varying,
  preview_generated_at timestamp without time zone,
  preview_error text,
  CONSTRAINT documents_pkey PRIMARY KEY (id),
  CONSTRAINT fk_documents_claim FOREIGN KEY (claim_id) REFERENCES public.claims(id),
  CONSTRAINT fk_documents_org FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.endorsement_extractions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  claim_id uuid,
  document_id uuid,
  endorsement_id uuid,
  extraction_data jsonb NOT NULL DEFAULT '{}'::jsonb CHECK (jsonb_typeof(extraction_data) = 'object'::text),
  extraction_status character varying DEFAULT 'completed'::character varying,
  precedence_priority integer NOT NULL DEFAULT 100,
  endorsement_type character varying NOT NULL DEFAULT 'general'::character varying,
  extracted_at timestamp without time zone DEFAULT now(),
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  extraction_version integer NOT NULL DEFAULT 1,
  applies_to_coverages jsonb NOT NULL DEFAULT '[]'::jsonb,
  jurisdiction character varying,
  status character varying DEFAULT 'completed'::character varying,
  form_code character varying NOT NULL DEFAULT ''::character varying,
  title character varying,
  edition_date character varying,
  applies_to_policy_forms jsonb DEFAULT '[]'::jsonb,
  modifications jsonb DEFAULT '{}'::jsonb,
  tables jsonb DEFAULT '[]'::jsonb,
  raw_text text,
  extraction_model character varying,
  error_message text,
  raw_openai_response jsonb,
  CONSTRAINT endorsement_extractions_pkey PRIMARY KEY (id),
  CONSTRAINT endorsement_extractions_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT endorsement_extractions_claim_id_fkey FOREIGN KEY (claim_id) REFERENCES public.claims(id),
  CONSTRAINT endorsement_extractions_document_id_fkey FOREIGN KEY (document_id) REFERENCES public.documents(id)
);
CREATE TABLE public.estimate_areas (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  structure_id uuid NOT NULL,
  name character varying NOT NULL,
  area_type character varying NOT NULL,
  total_sf numeric DEFAULT '0'::numeric,
  rcv_total numeric DEFAULT '0'::numeric,
  acv_total numeric DEFAULT '0'::numeric,
  sort_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT estimate_areas_pkey PRIMARY KEY (id)
);
CREATE TABLE public.estimate_coverage_summary (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  estimate_id uuid NOT NULL,
  coverage_code character varying NOT NULL,
  subtotal_rcv numeric DEFAULT '0'::numeric,
  tax_amount numeric DEFAULT '0'::numeric,
  overhead_amount numeric DEFAULT '0'::numeric,
  profit_amount numeric DEFAULT '0'::numeric,
  total_rcv numeric DEFAULT '0'::numeric,
  recoverable_depreciation numeric DEFAULT '0'::numeric,
  non_recoverable_depreciation numeric DEFAULT '0'::numeric,
  total_depreciation numeric DEFAULT '0'::numeric,
  total_acv numeric DEFAULT '0'::numeric,
  deductible numeric DEFAULT '0'::numeric,
  net_claim numeric DEFAULT '0'::numeric,
  CONSTRAINT estimate_coverage_summary_pkey PRIMARY KEY (id)
);
CREATE TABLE public.estimate_coverages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  estimate_id uuid NOT NULL,
  coverage_type character varying NOT NULL DEFAULT '0'::character varying,
  coverage_name character varying NOT NULL,
  policy_limit numeric DEFAULT '0'::numeric,
  deductible numeric DEFAULT '0'::numeric,
  line_item_total numeric DEFAULT '0'::numeric,
  tax_total numeric DEFAULT '0'::numeric,
  overhead_total numeric DEFAULT '0'::numeric,
  profit_total numeric DEFAULT '0'::numeric,
  rcv_total numeric DEFAULT '0'::numeric,
  depreciation_total numeric DEFAULT '0'::numeric,
  acv_total numeric DEFAULT '0'::numeric,
  recoverable_depreciation numeric DEFAULT '0'::numeric,
  non_recoverable_depreciation numeric DEFAULT '0'::numeric,
  net_claim numeric DEFAULT '0'::numeric,
  sort_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT estimate_coverages_pkey PRIMARY KEY (id)
);
CREATE TABLE public.estimate_line_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  estimate_id uuid NOT NULL,
  line_item_id uuid,
  line_item_code character varying NOT NULL,
  line_item_description text NOT NULL,
  category_id character varying,
  quantity numeric NOT NULL,
  unit character varying NOT NULL,
  unit_price numeric NOT NULL,
  material_cost numeric DEFAULT '0'::numeric,
  labor_cost numeric DEFAULT '0'::numeric,
  equipment_cost numeric DEFAULT '0'::numeric,
  subtotal numeric NOT NULL,
  source character varying DEFAULT 'manual'::character varying,
  damage_zone_id uuid,
  room_name character varying,
  notes text,
  is_approved boolean DEFAULT true,
  sort_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  coverage_id uuid,
  zone_id uuid,
  calculated_quantity numeric,
  quantity_source character varying DEFAULT 'manual'::character varying,
  quantity_explanation text,
  original_unit_price numeric,
  waste_factor numeric DEFAULT 0,
  waste_amount numeric DEFAULT 0,
  tax_amount numeric DEFAULT 0,
  line_rcv numeric DEFAULT 0,
  rcv numeric DEFAULT 0,
  age_years integer DEFAULT 0,
  useful_life_years integer DEFAULT 0,
  life_expectancy_years integer,
  condition character varying DEFAULT 'Average'::character varying,
  depreciation_pct numeric DEFAULT 0,
  depreciation_amount numeric DEFAULT 0,
  depreciation_type_id integer DEFAULT 0,
  depreciation_reason text,
  is_recoverable boolean DEFAULT true,
  acv numeric DEFAULT 0,
  coverage_code character varying DEFAULT 'A'::character varying,
  trade_code character varying,
  category_code character varying,
  selector_code character varying,
  activity_code character varying,
  calc_ref character varying,
  scope_reason text,
  is_auto_added boolean DEFAULT false,
  added_by_item character varying,
  is_homeowner boolean DEFAULT false,
  is_credit boolean DEFAULT false,
  is_non_op boolean DEFAULT false,
  is_price_override boolean DEFAULT false,
  rule_status character varying DEFAULT 'allowed'::character varying,
  original_quantity numeric,
  rule_explanation text,
  documentation_required jsonb DEFAULT '[]'::jsonb,
  documentation_provided jsonb DEFAULT '[]'::jsonb,
  damage_area_id uuid,
  CONSTRAINT estimate_line_items_pkey PRIMARY KEY (id),
  CONSTRAINT estimate_line_items_zone_id_fkey FOREIGN KEY (zone_id) REFERENCES public.estimate_zones(id),
  CONSTRAINT estimate_line_items_estimate_id_fkey FOREIGN KEY (estimate_id) REFERENCES public.estimates(id),
  CONSTRAINT estimate_line_items_line_item_id_fkey FOREIGN KEY (line_item_id) REFERENCES public.line_items(id),
  CONSTRAINT fk_estimate_line_items_estimate FOREIGN KEY (estimate_id) REFERENCES public.estimates(id)
);
CREATE TABLE public.estimate_missing_walls (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  zone_id uuid NOT NULL,
  name character varying,
  opening_type character varying NOT NULL DEFAULT 'door'::character varying,
  width_ft numeric NOT NULL,
  height_ft numeric NOT NULL,
  quantity integer DEFAULT 1,
  goes_to_floor boolean DEFAULT true,
  goes_to_ceiling boolean DEFAULT false,
  opens_into character varying,
  sort_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT estimate_missing_walls_pkey PRIMARY KEY (id)
);
CREATE TABLE public.estimate_structures (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  estimate_id uuid NOT NULL,
  coverage_id uuid,
  name character varying NOT NULL,
  description text,
  sketch_name character varying,
  sketch_page integer DEFAULT 1,
  year_built integer,
  construction_type character varying,
  stories integer DEFAULT 1,
  total_sf numeric DEFAULT '0'::numeric,
  rcv_total numeric DEFAULT '0'::numeric,
  acv_total numeric DEFAULT '0'::numeric,
  sort_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT estimate_structures_pkey PRIMARY KEY (id)
);
CREATE TABLE public.estimate_subrooms (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  zone_id uuid NOT NULL,
  name character varying NOT NULL,
  subroom_type character varying,
  length_ft numeric NOT NULL,
  width_ft numeric NOT NULL,
  height_ft numeric,
  dimensions jsonb DEFAULT '{}'::jsonb,
  is_addition boolean DEFAULT true,
  sort_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT estimate_subrooms_pkey PRIMARY KEY (id)
);
CREATE TABLE public.estimate_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  description text,
  damage_type character varying NOT NULL,
  template_items jsonb DEFAULT '[]'::jsonb,
  usage_count integer DEFAULT 0,
  is_public boolean DEFAULT false,
  created_by character varying,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT estimate_templates_pkey PRIMARY KEY (id)
);
CREATE TABLE public.estimate_totals (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  estimate_id uuid NOT NULL UNIQUE,
  line_item_total numeric DEFAULT '0'::numeric,
  material_total numeric DEFAULT '0'::numeric,
  labor_total numeric DEFAULT '0'::numeric,
  equipment_total numeric DEFAULT '0'::numeric,
  tax_total numeric DEFAULT '0'::numeric,
  op_base numeric DEFAULT '0'::numeric,
  overhead_total numeric DEFAULT '0'::numeric,
  profit_total numeric DEFAULT '0'::numeric,
  rcv_total numeric DEFAULT '0'::numeric,
  depreciation_total numeric DEFAULT '0'::numeric,
  recoverable_depreciation numeric DEFAULT '0'::numeric,
  non_recoverable_depreciation numeric DEFAULT '0'::numeric,
  acv_total numeric DEFAULT '0'::numeric,
  homeowner_total numeric DEFAULT '0'::numeric,
  contractor_total numeric DEFAULT '0'::numeric,
  deductible_total numeric DEFAULT '0'::numeric,
  net_claim numeric DEFAULT '0'::numeric,
  trade_count integer DEFAULT 0,
  qualifies_for_op boolean DEFAULT false,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT estimate_totals_pkey PRIMARY KEY (id)
);
CREATE TABLE public.estimate_zones (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  area_id uuid NOT NULL,
  name character varying NOT NULL,
  zone_code character varying,
  zone_type character varying NOT NULL DEFAULT 'room'::character varying,
  status character varying NOT NULL DEFAULT 'pending'::character varying,
  room_type character varying,
  floor_level character varying DEFAULT 'main'::character varying,
  length_ft numeric,
  width_ft numeric,
  height_ft numeric DEFAULT 8.0,
  pitch character varying,
  pitch_multiplier numeric DEFAULT 1.0,
  dimensions jsonb DEFAULT '{}'::jsonb,
  room_info jsonb DEFAULT '{}'::jsonb,
  sketch_polygon jsonb DEFAULT 'null'::jsonb,
  damage_type character varying,
  damage_severity character varying,
  water_category integer,
  water_class integer,
  affected_surfaces jsonb DEFAULT '[]'::jsonb,
  associated_peril character varying,
  peril_confidence numeric,
  photo_ids jsonb DEFAULT '[]'::jsonb,
  line_item_count integer DEFAULT 0,
  rcv_total numeric DEFAULT '0'::numeric,
  acv_total numeric DEFAULT '0'::numeric,
  notes text,
  sort_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT estimate_zones_pkey PRIMARY KEY (id)
);
CREATE TABLE public.estimates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  claim_id uuid,
  claim_number character varying,
  property_address text,
  status character varying DEFAULT 'draft'::character varying,
  version integer DEFAULT 1,
  subtotal numeric DEFAULT '0'::numeric,
  overhead_amount numeric DEFAULT '0'::numeric,
  overhead_pct numeric DEFAULT 10.00,
  profit_amount numeric DEFAULT '0'::numeric,
  profit_pct numeric DEFAULT 10.00,
  tax_amount numeric DEFAULT '0'::numeric,
  tax_pct numeric DEFAULT '0'::numeric,
  grand_total numeric DEFAULT '0'::numeric,
  region_id character varying DEFAULT 'US-NATIONAL'::character varying,
  carrier_profile_id uuid,
  created_by character varying,
  approved_by character varying,
  notes text,
  is_locked boolean DEFAULT false,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  submitted_at timestamp without time zone,
  finalized_at timestamp without time zone,
  workflow_status character varying DEFAULT 'draft'::character varying,
  policy_number character varying,
  policy_type character varying,
  xact_settings jsonb DEFAULT '{}'::jsonb,
  op_threshold numeric DEFAULT 0,
  op_trade_minimum integer DEFAULT 3,
  qualifies_for_op boolean DEFAULT false,
  date_of_loss date,
  date_inspected date,
  year_built integer,
  roof_age_years integer,
  overall_condition character varying DEFAULT 'Average'::character varying,
  deductible_cov_a numeric DEFAULT 0,
  deductible_cov_b numeric DEFAULT 0,
  deductible_cov_c numeric DEFAULT 0,
  subtotal_materials numeric DEFAULT 0,
  subtotal_labor numeric DEFAULT 0,
  subtotal_equipment numeric DEFAULT 0,
  total_rcv numeric DEFAULT 0,
  total_depreciation numeric DEFAULT 0,
  total_acv numeric DEFAULT 0,
  recoverable_depreciation numeric DEFAULT 0,
  non_recoverable_depreciation numeric DEFAULT 0,
  net_claim_cov_a numeric DEFAULT 0,
  net_claim_cov_b numeric DEFAULT 0,
  net_claim_cov_c numeric DEFAULT 0,
  net_claim_total numeric DEFAULT 0,
  jurisdiction_id uuid,
  price_list_id uuid,
  rules_evaluated_at timestamp without time zone,
  rules_evaluation_version integer DEFAULT 0,
  exported_at timestamp without time zone,
  esx_version integer DEFAULT 0,
  CONSTRAINT estimates_pkey PRIMARY KEY (id),
  CONSTRAINT estimates_jurisdiction_id_fkey FOREIGN KEY (jurisdiction_id) REFERENCES public.jurisdictions(id),
  CONSTRAINT estimates_price_list_id_fkey FOREIGN KEY (price_list_id) REFERENCES public.price_lists(id),
  CONSTRAINT estimates_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT estimates_claim_id_fkey FOREIGN KEY (claim_id) REFERENCES public.claims(id),
  CONSTRAINT fk_estimates_org FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT fk_estimates_claim FOREIGN KEY (claim_id) REFERENCES public.claims(id)
);
CREATE TABLE public.inspection_appointments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  claim_id uuid NOT NULL,
  user_id uuid NOT NULL,
  organization_id uuid,
  title text NOT NULL,
  description text,
  location text,
  scheduled_start timestamp with time zone NOT NULL,
  scheduled_end timestamp with time zone NOT NULL,
  duration_minutes integer DEFAULT 60,
  status character varying DEFAULT 'scheduled'::character varying,
  appointment_type character varying DEFAULT 'initial_inspection'::character varying,
  ms365_event_id text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT inspection_appointments_pkey PRIMARY KEY (id)
);
CREATE TABLE public.inspection_workflow_assets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  step_id uuid NOT NULL,
  asset_type character varying NOT NULL,
  label character varying NOT NULL,
  description text,
  required boolean DEFAULT true,
  min_count integer DEFAULT 1,
  max_count integer,
  guidance text,
  example_url text,
  status character varying NOT NULL DEFAULT 'pending'::character varying,
  document_id uuid,
  photo_id uuid,
  measurement_value text,
  measurement_unit character varying,
  captured_at timestamp without time zone,
  notes text,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT inspection_workflow_assets_pkey PRIMARY KEY (id)
);
CREATE TABLE public.inspection_workflow_rooms (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  workflow_id uuid NOT NULL,
  name character varying NOT NULL,
  level character varying,
  room_type character varying,
  length_ft numeric,
  width_ft numeric,
  height_ft numeric,
  damage_types ARRAY,
  damage_severity character varying,
  notes text,
  inspection_complete boolean DEFAULT false,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT inspection_workflow_rooms_pkey PRIMARY KEY (id)
);
CREATE TABLE public.inspection_workflow_steps (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  workflow_id uuid NOT NULL,
  step_index integer NOT NULL,
  phase character varying NOT NULL,
  step_type character varying NOT NULL,
  title character varying NOT NULL,
  description text,
  instructions text,
  priority character varying DEFAULT 'normal'::character varying,
  estimated_minutes integer DEFAULT 5,
  location_context character varying,
  room_id uuid,
  structure_id uuid,
  damage_zone_id uuid,
  checklist_items jsonb DEFAULT '[]'::jsonb,
  status character varying NOT NULL DEFAULT 'pending'::character varying,
  started_at timestamp without time zone,
  completed_at timestamp without time zone,
  skipped_at timestamp without time zone,
  skip_reason text,
  completion_notes text,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  peril_specific character varying DEFAULT NULL::character varying,
  required boolean DEFAULT true,
  tags jsonb DEFAULT '[]'::jsonb,
  dependencies jsonb DEFAULT '[]'::jsonb,
  actual_minutes integer,
  completed_by character varying,
  notes text,
  room_name character varying,
  CONSTRAINT inspection_workflow_steps_pkey PRIMARY KEY (id)
);
CREATE TABLE public.inspection_workflows (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  claim_id uuid NOT NULL,
  version integer NOT NULL DEFAULT 1,
  status character varying NOT NULL DEFAULT 'draft'::character varying,
  generation_source character varying,
  generation_metadata jsonb DEFAULT '{}'::jsonb,
  steps_summary jsonb DEFAULT '{}'::jsonb,
  total_steps integer DEFAULT 0,
  completed_steps integer DEFAULT 0,
  notes text,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  started_at timestamp without time zone,
  completed_at timestamp without time zone,
  archived_at timestamp without time zone,
  created_by character varying,
  generated_from jsonb,
  primary_peril character varying,
  secondary_perils jsonb DEFAULT '[]'::jsonb,
  source_briefing_id uuid,
  workflow_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  CONSTRAINT inspection_workflows_pkey PRIMARY KEY (id),
  CONSTRAINT fk_inspection_workflows_claim FOREIGN KEY (claim_id) REFERENCES public.claims(id),
  CONSTRAINT fk_inspection_workflows_org FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.jurisdiction_rules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  jurisdiction_id uuid NOT NULL,
  rule_code character varying NOT NULL,
  rule_name character varying NOT NULL,
  rule_type character varying NOT NULL,
  target_type character varying NOT NULL,
  target_value character varying,
  conditions jsonb DEFAULT '{}'::jsonb,
  effect_type character varying NOT NULL,
  effect_value jsonb NOT NULL,
  explanation_template text,
  regulatory_reference character varying,
  effective_date date DEFAULT CURRENT_DATE,
  expiration_date date,
  priority integer DEFAULT 100,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT jurisdiction_rules_pkey PRIMARY KEY (id)
);
CREATE TABLE public.jurisdictions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code character varying NOT NULL UNIQUE,
  name character varying NOT NULL,
  state_code character varying,
  country_code character varying DEFAULT 'US'::character varying,
  sales_tax_rate numeric DEFAULT 0.0000,
  labor_taxable boolean DEFAULT false,
  materials_taxable boolean DEFAULT true,
  equipment_taxable boolean DEFAULT false,
  op_allowed boolean DEFAULT true,
  op_threshold_override numeric,
  op_trade_minimum_override integer,
  op_max_pct numeric DEFAULT 20.00,
  licensed_trades_only boolean DEFAULT false,
  licensed_trades jsonb DEFAULT '[]'::jsonb,
  labor_rate_maximum jsonb DEFAULT '{}'::jsonb,
  minimum_charge numeric,
  service_call_minimum numeric,
  regulatory_constraints jsonb DEFAULT '{}'::jsonb,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT jurisdictions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.labor_rates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  trade_code character varying NOT NULL,
  trade_name character varying NOT NULL,
  hourly_rate numeric NOT NULL,
  region_code character varying DEFAULT 'NATIONAL'::character varying,
  effective_date date DEFAULT CURRENT_DATE,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT labor_rates_pkey PRIMARY KEY (id)
);
CREATE TABLE public.labor_rates_enhanced (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  trade_code character varying NOT NULL,
  trade_name character varying NOT NULL,
  base_hourly_rate numeric NOT NULL,
  overtime_multiplier numeric DEFAULT 1.50,
  region_code character varying DEFAULT 'NATIONAL'::character varying,
  effective_date date DEFAULT CURRENT_DATE,
  is_active boolean DEFAULT true,
  CONSTRAINT labor_rates_enhanced_pkey PRIMARY KEY (id)
);
CREATE TABLE public.line_item_categories (
  id character varying NOT NULL,
  parent_id character varying,
  name character varying NOT NULL,
  description text,
  sort_order integer DEFAULT 0,
  default_coverage_code character varying DEFAULT 'A'::character varying,
  CONSTRAINT line_item_categories_pkey PRIMARY KEY (id),
  CONSTRAINT line_item_categories_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.line_item_categories(id)
);
CREATE TABLE public.line_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  category_id character varying,
  code character varying NOT NULL UNIQUE,
  name character varying NOT NULL,
  description text,
  unit character varying NOT NULL,
  unit_price numeric DEFAULT 0,
  material_cost numeric DEFAULT 0,
  labor_cost numeric DEFAULT 0,
  equipment_cost numeric DEFAULT 0,
  trade_code character varying,
  depreciation_type character varying,
  default_coverage_code character varying DEFAULT 'A'::character varying,
  labor_hours_per_unit numeric,
  xactimate_code character varying,
  quantity_formula text,
  scope_conditions jsonb,
  requires_items jsonb DEFAULT '[]'::jsonb,
  auto_add_items jsonb DEFAULT '[]'::jsonb,
  excludes_items jsonb DEFAULT '[]'::jsonb,
  replaces_items jsonb DEFAULT '[]'::jsonb,
  carrier_sensitivity_level character varying DEFAULT 'medium'::character varying,
  validation_rules jsonb,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT line_items_pkey PRIMARY KEY (id),
  CONSTRAINT line_items_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.line_item_categories(id)
);
CREATE TABLE public.material_regional_prices (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  material_id uuid NOT NULL,
  region_id character varying NOT NULL,
  price numeric NOT NULL,
  source character varying,
  effective_date date DEFAULT CURRENT_DATE,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT material_regional_prices_pkey PRIMARY KEY (id),
  CONSTRAINT material_regional_prices_material_id_fkey FOREIGN KEY (material_id) REFERENCES public.materials(id),
  CONSTRAINT material_regional_prices_region_id_fkey FOREIGN KEY (region_id) REFERENCES public.regions(id)
);
CREATE TABLE public.materials (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  sku character varying NOT NULL UNIQUE,
  name character varying NOT NULL,
  description text,
  category character varying,
  unit character varying NOT NULL,
  manufacturer character varying,
  model_number character varying,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT materials_pkey PRIMARY KEY (id)
);
CREATE TABLE public.organization_memberships (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  organization_id uuid NOT NULL,
  role character varying NOT NULL DEFAULT 'member'::character varying,
  status character varying NOT NULL DEFAULT 'active'::character varying,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT organization_memberships_pkey PRIMARY KEY (id),
  CONSTRAINT organization_memberships_user_id_users_id_fk FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT fk_org_membership_user FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT fk_org_membership_org FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.organizations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  slug character varying NOT NULL UNIQUE,
  type character varying NOT NULL DEFAULT 'carrier'::character varying,
  email character varying,
  phone character varying,
  address text,
  settings jsonb DEFAULT '{}'::jsonb,
  status character varying NOT NULL DEFAULT 'active'::character varying,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT organizations_pkey PRIMARY KEY (id)
);
CREATE TABLE public.policy_form_extractions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  claim_id uuid,
  document_id uuid,
  policy_form_id uuid,
  extraction_data jsonb NOT NULL DEFAULT '{}'::jsonb CHECK (jsonb_typeof(extraction_data) = 'object'::text),
  extraction_status character varying DEFAULT 'completed'::character varying,
  extracted_at timestamp without time zone DEFAULT now(),
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  extraction_version integer NOT NULL DEFAULT 1,
  source_form_code text,
  jurisdiction character varying,
  is_canonical boolean NOT NULL DEFAULT true,
  status character varying DEFAULT 'completed'::character varying,
  document_type character varying,
  policy_form_code character varying,
  policy_form_name character varying,
  edition_date character varying,
  page_count integer,
  policy_structure jsonb DEFAULT '{}'::jsonb,
  definitions jsonb DEFAULT '[]'::jsonb,
  section_i jsonb DEFAULT '{}'::jsonb,
  section_ii jsonb DEFAULT '{}'::jsonb,
  general_conditions jsonb DEFAULT '[]'::jsonb,
  raw_page_text text,
  extraction_model character varying,
  extraction_version_str character varying,
  prompt_tokens integer,
  completion_tokens integer,
  total_tokens integer,
  error_message text,
  raw_openai_response jsonb,
  CONSTRAINT policy_form_extractions_pkey PRIMARY KEY (id),
  CONSTRAINT policy_form_extractions_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT policy_form_extractions_claim_id_fkey FOREIGN KEY (claim_id) REFERENCES public.claims(id),
  CONSTRAINT policy_form_extractions_document_id_fkey FOREIGN KEY (document_id) REFERENCES public.documents(id)
);
CREATE TABLE public.price_lists (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code character varying NOT NULL UNIQUE,
  name character varying NOT NULL,
  region_code character varying NOT NULL,
  effective_date date NOT NULL,
  expiration_date date,
  source character varying DEFAULT 'internal'::character varying,
  base_multiplier numeric DEFAULT 1.0000,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT price_lists_pkey PRIMARY KEY (id)
);
CREATE TABLE public.price_scrape_jobs (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  source character varying NOT NULL,
  status character varying DEFAULT 'pending'::character varying,
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  items_processed integer DEFAULT 0,
  items_updated integer DEFAULT 0,
  errors jsonb DEFAULT '[]'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT price_scrape_jobs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.regional_multipliers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  region_code character varying NOT NULL UNIQUE,
  region_name character varying NOT NULL,
  material_multiplier numeric DEFAULT 1.0000,
  labor_multiplier numeric DEFAULT 1.0000,
  equipment_multiplier numeric DEFAULT 1.0000,
  is_active boolean DEFAULT true,
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT regional_multipliers_pkey PRIMARY KEY (id)
);
CREATE TABLE public.regions (
  id character varying NOT NULL,
  name character varying NOT NULL,
  state character varying,
  price_index numeric DEFAULT 1.0000,
  labor_index numeric DEFAULT 1.0000,
  material_index numeric DEFAULT 1.0000,
  equipment_index numeric DEFAULT 1.0000,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  state_province character varying,
  zip_postal_prefixes ARRAY,
  currency character DEFAULT 'USD'::bpchar,
  tax_rate numeric DEFAULT 0,
  indices jsonb NOT NULL DEFAULT '{}'::jsonb,
  metadata jsonb DEFAULT '{}'::jsonb,
  last_updated timestamp without time zone DEFAULT now(),
  CONSTRAINT regions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.rule_effects (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  estimate_id uuid NOT NULL,
  estimate_line_item_id uuid,
  zone_id uuid,
  rule_source character varying NOT NULL,
  rule_id uuid,
  rule_code character varying NOT NULL,
  effect_type character varying NOT NULL,
  original_value jsonb,
  modified_value jsonb,
  explanation_text text NOT NULL,
  applied_at timestamp without time zone DEFAULT now(),
  applied_by character varying,
  is_override boolean DEFAULT false,
  override_reason text,
  override_by character varying,
  CONSTRAINT rule_effects_pkey PRIMARY KEY (id)
);
CREATE TABLE public.session (
  sid character varying NOT NULL,
  sess json NOT NULL,
  expire timestamp without time zone NOT NULL,
  CONSTRAINT session_pkey PRIMARY KEY (sid)
);
CREATE TABLE public.sessions (
  sid character varying NOT NULL,
  sess jsonb NOT NULL,
  expire timestamp with time zone NOT NULL,
  CONSTRAINT sessions_pkey PRIMARY KEY (sid)
);
CREATE TABLE public.tax_rates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  region_code character varying NOT NULL,
  tax_type character varying NOT NULL,
  tax_name character varying NOT NULL,
  rate numeric NOT NULL,
  applies_to character varying DEFAULT 'materials'::character varying,
  is_active boolean DEFAULT true,
  effective_date date DEFAULT CURRENT_DATE,
  CONSTRAINT tax_rates_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_ms365_tokens (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  access_token text NOT NULL,
  refresh_token text,
  expires_at timestamp with time zone NOT NULL,
  scopes ARRAY,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_ms365_tokens_pkey PRIMARY KEY (id)
);
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  username text NOT NULL UNIQUE,
  email character varying,
  password text NOT NULL,
  first_name character varying,
  last_name character varying,
  role character varying NOT NULL DEFAULT 'user'::character varying,
  current_organization_id uuid,
  preferences jsonb DEFAULT '{}'::jsonb,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT users_pkey PRIMARY KEY (id)
);
CREATE TABLE public.xact_categories (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  cat_id integer NOT NULL,
  xact_id integer NOT NULL,
  code character varying NOT NULL UNIQUE,
  description text NOT NULL,
  coverage_type integer DEFAULT 0,
  labor_dist_pct integer DEFAULT 59,
  material_dist_pct integer DEFAULT 41,
  op_eligible boolean DEFAULT true,
  taxable boolean DEFAULT true,
  no_prefix boolean DEFAULT false,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT xact_categories_pkey PRIMARY KEY (id)
);
CREATE TABLE public.xact_components (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  component_type character varying NOT NULL,
  code character varying NOT NULL,
  description text NOT NULL,
  unit character varying,
  amount numeric,
  xact_id character varying,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp without time zone DEFAULT now(),
  line_item_code character varying,
  CONSTRAINT xact_components_pkey PRIMARY KEY (id)
);
CREATE TABLE public.xact_line_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  item_id integer NOT NULL,
  xact_id integer NOT NULL,
  category_code character varying NOT NULL,
  selector_code character varying NOT NULL,
  full_code character varying NOT NULL,
  description text NOT NULL,
  unit character varying NOT NULL,
  op_eligible boolean DEFAULT true,
  taxable boolean DEFAULT true,
  labor_efficiency integer,
  material_dist_pct integer,
  search_group character varying,
  search_category character varying,
  activities jsonb DEFAULT '[]'::jsonb,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp without time zone DEFAULT now(),
  code character varying UNIQUE,
  CONSTRAINT xact_line_items_pkey PRIMARY KEY (id)
);
CREATE TABLE public.zone_connections (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  estimate_id uuid NOT NULL,
  from_zone_id uuid NOT NULL,
  to_zone_id uuid NOT NULL,
  connection_type character varying NOT NULL,
  opening_id uuid,
  notes text,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT zone_connections_pkey PRIMARY KEY (id),
  CONSTRAINT zone_connections_estimate_id_fkey FOREIGN KEY (estimate_id) REFERENCES public.estimates(id),
  CONSTRAINT zone_connections_from_zone_id_fkey FOREIGN KEY (from_zone_id) REFERENCES public.estimate_zones(id),
  CONSTRAINT zone_connections_to_zone_id_fkey FOREIGN KEY (to_zone_id) REFERENCES public.estimate_zones(id),
  CONSTRAINT zone_connections_opening_id_fkey FOREIGN KEY (opening_id) REFERENCES public.zone_openings(id)
);
CREATE TABLE public.zone_openings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  zone_id uuid NOT NULL,
  opening_type character varying NOT NULL,
  wall_index integer NOT NULL,
  offset_from_vertex_ft numeric NOT NULL,
  width_ft numeric NOT NULL,
  height_ft numeric NOT NULL,
  sill_height_ft numeric,
  connects_to_zone_id uuid,
  notes text,
  sort_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT zone_openings_pkey PRIMARY KEY (id),
  CONSTRAINT zone_openings_zone_id_fkey FOREIGN KEY (zone_id) REFERENCES public.estimate_zones(id),
  CONSTRAINT zone_openings_connects_to_zone_id_fkey FOREIGN KEY (connects_to_zone_id) REFERENCES public.estimate_zones(id)
);