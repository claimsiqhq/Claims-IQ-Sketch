Good ‚Äî this is the **correct consolidation step**.

Below is **ONE complete, authoritative Claude Code prompt**, in **Markdown**, that contains **everything**:

* intent
* constraints
* schema
* validation rules
* generation logic
* how it plugs into your existing system

This is the prompt you paste into **Claude Code** and say *‚Äúimplement this‚Äù*.

No fragments. No references to earlier chats. No ambiguity.

---

# üß† CLAUDE CODE PROMPT

## Feature: Executable Inspection Workflow Generation (Claims IQ)

````markdown
# CONTEXT

You are working inside an existing full-stack application called Claims IQ.
The application already supports:
- FNOL ingestion and parsing
- Policy and endorsement parsing
- Peril inference
- AI-generated Claim Briefings (strategy-focused)
- Supabase / Postgres backend
- React frontend (mobile + desktop)

DO NOT remove or rewrite existing working features.
DO NOT change existing claim ingestion or briefing logic.
This task is ADDITIVE.

Your task is to implement a NEW capability:
EXECUTABLE INSPECTION WORKFLOW GENERATION.

This workflow is NOT a narrative.
It is NOT a summary.
It is a step-by-step execution plan that an adjuster follows in the field.

---

# GOAL

Create a system that automatically generates a **living, editable inspection workflow**
from:
- FNOL
- Policy
- Endorsements
- Existing AI Claim Briefing
- Peril inspection rules

The workflow must:
- Be ordered and phase-based
- Be endorsement-aware
- Define required evidence explicitly
- Support dynamic rooms
- Preserve human edits
- Be versioned and auditable
- Live in Claim Details as the execution layer after the briefing

This turns Claims IQ into an inspection control plane.

---

# PART 1 ‚Äî DATABASE (SUPABASE / POSTGRES)

Create migrations for the following tables.

## inspection_workflows
- id (uuid, pk)
- claim_id (uuid, fk ‚Üí claims.id)
- version (int, default 1)
- status (draft | active | completed | archived)
- primary_peril (text)
- secondary_perils (jsonb)
- source_briefing_id (uuid, nullable)
- workflow_json (jsonb)  -- canonical snapshot
- generated_from (jsonb) -- model, prompt key, document ids
- created_by (uuid)
- created_at (timestamp)
- updated_at (timestamp)

## inspection_workflow_steps
- id (uuid, pk)
- workflow_id (uuid, fk)
- step_index (int)
- phase (prep | safety | exterior | roof | interior | room | mitigation | closeout)
- step_type (text)
- title (text)
- instructions (text)
- required (boolean)
- tags (jsonb)
- dependencies (jsonb)
- estimated_minutes (int)
- status (todo | doing | done | skipped)
- created_at
- updated_at

## inspection_workflow_assets
- id (uuid, pk)
- step_id (uuid, fk)
- asset_type (photo_required | photo_captured | measurement | sketch | note)
- label (text)
- required (boolean)
- metadata (jsonb) -- e.g. ruler required, min_count, close_up
- file_id (uuid, nullable)
- status (missing | captured | not_applicable)
- created_at
- updated_at

## inspection_workflow_rooms
- id (uuid, pk)
- workflow_id (uuid, fk)
- name (text)
- level (basement | main | upper | attic | garage | exterior)
- notes (text)
- created_at

---

# PART 2 ‚Äî BACKEND SERVICE

Create `inspectionWorkflowService.ts`.

Responsibilities:
- generateInspectionWorkflow(claimId)
- regenerateWorkflow(claimId, reason)
- expandWorkflowForRooms(workflowId, roomNames[])
- validateWorkflowSchema(workflowJson)

Inputs for generation:
- Claim core data
- Parsed FNOL
- Parsed Policy
- Parsed Endorsements
- Primary + secondary peril
- Existing AI Claim Briefing JSON
- Peril inspection rules

Outputs:
- Strictly validated workflow JSON
- Normalized rows in workflow, steps, assets, rooms tables

Workflows must be versioned.
Human edits must be preserved on regeneration.

---

# PART 3 ‚Äî AI PROMPT (CORE LOGIC)

Register a new prompt key:

INSPECTION_WORKFLOW_GENERATOR

## SYSTEM PROMPT

You are an expert property insurance inspection planner.

Your task is to generate a STEP-BY-STEP, EXECUTABLE INSPECTION WORKFLOW
for a field adjuster.

This workflow is NOT a narrative.
It is NOT a summary.
It is an ordered execution plan.

You MUST:
- Output structured JSON only
- Follow the schema exactly
- Be peril-aware and endorsement-aware
- Explicitly define required evidence
- Assume rooms may be added dynamically
- Optimize for CAT-scale defensibility

You MUST NOT:
- Make coverage determinations
- Invent policy language
- Collapse steps into vague instructions
- Output prose outside JSON

## USER PROMPT (RUNTIME)

Generate an INSPECTION WORKFLOW using the inputs below.

### CLAIM CONTEXT
{{CLAIM_CONTEXT_JSON}}

### FNOL (STRUCTURED)
{{FNOL_JSON}}

### POLICY (STRUCTURED)
{{POLICY_JSON}}

### ENDORSEMENTS (STRUCTURED)
{{ENDORSEMENTS_JSON}}

### PRIMARY PERIL
{{PRIMARY_PERIL}}

### SECONDARY PERILS
{{SECONDARY_PERILS}}

### AI CLAIM BRIEFING
{{CLAIM_BRIEFING_JSON}}

### PERIL INSPECTION RULES
{{PERIL_RULES_JSON}}

---

## WORKFLOW REQUIREMENTS (MANDATORY)

1. Workflow MUST be divided into ordered PHASES:
   - Preparation
   - Safety
   - Exterior
   - Roof (if applicable)
   - Interior (room-based, expandable)
   - Utilities / Systems (if applicable)
   - Temporary Repairs / Mitigation (if applicable)
   - Closeout

2. Each phase MUST contain ordered, atomic steps.

3. Each step MUST include:
   - Clear instructions
   - Required flag
   - Estimated time
   - Explicit evidence requirements

4. Endorsements MUST:
   - Modify inspection behavior
   - Add or constrain evidence requirements
   - Never be mentioned abstractly

5. Interior inspections MUST:
   - Use a ROOM TEMPLATE
   - Allow dynamic room creation
   - Define default steps + evidence

6. The workflow MUST:
   - Be editable
   - Preserve human edits
   - Be auditable and defensible

---

## OUTPUT FORMAT (STRICT)

Return ONLY valid JSON:

```json
{
  "phases": [
    {
      "phase": "preparation",
      "steps": [
        {
          "step_id": "string",
          "title": "string",
          "instructions": "string",
          "required": true,
          "estimated_minutes": 10,
          "evidence_required": [
            {
              "type": "photo | measurement | sketch | note",
              "label": "string",
              "metadata": {
                "min_count": 1,
                "close_up": false,
                "requires_ruler": false
              }
            }
          ]
        }
      ]
    }
  ],
  "room_template": {
    "default_steps": [],
    "photo_requirements": [],
    "measurement_requirements": []
  },
  "tools_and_equipment": [],
  "open_questions_for_adjuster": []
}
````

---

## VALIDATION RULES (NON-NEGOTIABLE)

* Missing phases ‚Üí FAIL
* Missing evidence ‚Üí FAIL
* Ignored endorsements ‚Üí FAIL
* Non-JSON output ‚Üí FAIL
* Vague steps ‚Üí FAIL

If information is missing:

* Add a step to collect it
* OR add an open question
* Do NOT guess

Return JSON only.

---

# PART 4 ‚Äî API ENDPOINTS

Implement:

* POST   /claims/:id/workflow/generate
* GET    /claims/:id/workflow
* PATCH  /workflow/:id/steps/:stepId
* POST   /workflow/:id/steps
* POST   /workflow/:id/rooms
* POST   /workflow/:id/expand-rooms

Workflow auto-generates after briefing if none exists.

---

# PART 5 ‚Äî FRONTEND

Add a new ‚ÄúWorkflow‚Äù tab to Claim Details.

Requirements:

* Phase navigation
* Ordered step cards
* Required evidence checklist
* Add step / add room
* Upload photos from step
* Mobile-first execution

DO NOT redesign the app.
Follow existing component patterns.

---

# PART 6 ‚Äî SAFETY + STATE

Mark workflow stale if:

* Endorsements change
* Peril changes
* Policy coverage changes

Prompt user before regeneration.
Preserve prior versions.

---

# DELIVERABLES

* Database migrations
* Backend services
* Prompt registration
* API routes
* Frontend Workflow tab
* Schema validation

Do not summarize.
Implement exactly as specified.

```

---

### Final note (important)

This prompt is **not exploratory**.  
It is **architectural instruction**.

If Claude follows this, you get:
- deterministic workflows
- human + AI co-execution
- defensible inspections
- a real moat

If you want, next we can:
- tighten regeneration/merge logic
- add CAT acceleration heuristics
- add voice-compatible step phrasing

But this prompt is now **complete and correct**.
```
