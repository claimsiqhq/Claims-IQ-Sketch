I’ll create two comprehensive Claude Code prompts that you can use directly with your repo. These are designed to be copy-pasted into Claude Code sessions.

-----

## Prompt 1: Expand Line Item Library

```markdown
# CLAUDE CODE TASK: Expand Line Item Library

## Context
This is a property insurance claims estimation platform. We have an existing PostgreSQL database with a line_items table and related tables for materials, labor rates, and pricing. The current seed data covers water mitigation basics. We need to expand to cover comprehensive property damage scenarios.

## Existing Schema Reference
The line_items table has this structure:
- code: VARCHAR(50) - unique identifier like 'DRY-HTT-12'
- category_id: VARCHAR(20) - references line_item_categories
- description: VARCHAR(500)
- unit: VARCHAR(20) - 'SF', 'LF', 'EA', 'HR', 'CY', 'SY'
- material_components: JSONB array of {sku, qty_per_unit}
- labor_components: JSONB array of {task, hours_per_unit, trade}
- equipment_components: JSONB array of {type, cost_per_unit, condition?}
- waste_factor: DECIMAL default 1.00
- minimum_charge: DECIMAL default 0
- scope_triggers: JSONB array of damage conditions that auto-suggest this item
- related_items: TEXT array of codes commonly paired with this item

Trades for labor: 'general', 'skilled', 'specialty', 'electrical', 'plumbing', 'hvac'

## Task
Create a comprehensive SQL seed file that adds line items for the following categories. Follow the existing patterns in the codebase for consistency.

### Categories to Add/Expand

**1. Fire & Smoke Restoration (Category 04)**
- 04.1 - Smoke Damage Assessment
- 04.2 - Soot Removal (dry soot, wet soot, protein residue)
- 04.3 - Odor Control (thermal fogging, ozone, hydroxyl)
- 04.4 - HVAC Cleaning
- 04.5 - Electronics Cleaning
- 04.6 - Document/Photo Recovery

**2. Roofing (Category 12)**
- 12.1 - Shingle Roofing (3-tab, architectural, premium)
- 12.2 - Underlayment (felt, synthetic)
- 12.3 - Flashing (step, valley, chimney, vent)
- 12.4 - Ventilation (ridge vent, box vent, soffit vent)
- 12.5 - Gutters & Downspouts
- 12.6 - Skylights
- 12.7 - Roof Decking repair/replacement

**3. Exterior/Siding (Category 13)**
- 13.1 - Vinyl Siding
- 13.2 - Fiber Cement (HardiePlank)
- 13.3 - Wood Siding
- 13.4 - Stucco
- 13.5 - Brick Veneer repair
- 13.6 - Soffit & Fascia
- 13.7 - Exterior Painting

**4. Windows & Doors (Category 08)**
- 08.1 - Window Replacement (vinyl, wood, aluminum by size)
- 08.2 - Window Repair (glass only, sash, hardware)
- 08.3 - Exterior Doors (entry, sliding glass, French)
- 08.4 - Interior Doors (hollow core, solid core, specialty)
- 08.5 - Door Hardware
- 08.6 - Garage Doors

**5. Electrical (Category 10)**
- 10.1 - Outlets & Switches
- 10.2 - Lighting Fixtures
- 10.3 - Ceiling Fans
- 10.4 - Panel/Breaker work
- 10.5 - Smoke/CO Detectors
- 10.6 - Low Voltage (doorbell, thermostat wire)

**6. Plumbing (Category 09)**
- 09.1 - Fixture Replacement (toilet, sink, faucet)
- 09.2 - Water Heater
- 09.3 - Pipe Repair
- 09.4 - Drain Cleaning
- 09.5 - Shut-off Valves

**7. HVAC (Category 11)**
- 11.1 - Ductwork (flex, rigid, insulated)
- 11.2 - Registers & Grilles
- 11.3 - HVAC Equipment
- 11.4 - Duct Cleaning

**8. Cabinets & Countertops (Category 08 - Kitchen/Bath)**
- 08.7 - Base Cabinets
- 08.8 - Wall Cabinets
- 08.9 - Countertops (laminate, granite, quartz, solid surface)
- 08.10 - Cabinet Hardware

**9. Additional Flooring (expand Category 07)**
- 07.3 - Ceramic/Porcelain Tile
- 07.5 - Laminate
- 07.6 - Hardwood Refinishing
- 07.7 - Subfloor Repair/Replacement
- 07.8 - Floor Transitions

**10. Insulation (Category 05)**
- 05.1 - Batt Insulation (R-13, R-19, R-30, R-38)
- 05.2 - Blown Insulation
- 05.3 - Spray Foam
- 05.4 - Vapor Barrier

### Requirements for Each Line Item

1. **Realistic Pricing Components**
   - Material components should reference SKUs in materials table (add new materials as needed)
   - Labor hours should be realistic for the task
   - Include equipment costs where applicable

2. **Scope Triggers**
   - Define what damage scenarios auto-suggest this item
   - Include damage_type, severity levels, affected surfaces where relevant

3. **Related Items**
   - Link items that are commonly used together
   - Example: Drywall replacement should relate to paint, texture, primer

4. **Waste Factors**
   - 1.10 (10%) for most materials
   - 1.05 (5%) for precision work
   - 1.15 (15%) for complex cuts/patterns

5. **Minimum Charges**
   - Small repair items should have minimums
   - Example: Drywall patch minimum $50, electrical outlet minimum $75

### Output Structure

Create the following files:

1. `db/seeds/02_categories_expanded.sql` - New categories
2. `db/seeds/03_materials_expanded.sql` - New materials for new line items
3. `db/seeds/04_line_items_fire_smoke.sql` - Fire/smoke restoration items
4. `db/seeds/05_line_items_roofing.sql` - Roofing items
5. `db/seeds/06_line_items_exterior.sql` - Exterior/siding items
6. `db/seeds/07_line_items_windows_doors.sql` - Windows and doors
7. `db/seeds/08_line_items_mep.sql` - Mechanical/Electrical/Plumbing
8. `db/seeds/09_line_items_cabinets.sql` - Cabinets and countertops
9. `db/seeds/10_line_items_flooring_expanded.sql` - Additional flooring
10. `db/seeds/11_line_items_insulation.sql` - Insulation items

### Example Line Item Format (follow this pattern)

```sql
INSERT INTO line_items (
    code, category_id, description, unit,
    material_components, labor_components, equipment_components,
    waste_factor, minimum_charge, scope_triggers, related_items
) VALUES (
    'ROOF-SHNG-ARCH',
    '12.1',
    'Roofing - Architectural shingles - remove & replace',
    'SQ',  -- roofing square = 100 SF
    '[
        {"sku": "SHNG-ARCH-BDL", "qty_per_unit": 3.0},
        {"sku": "FELT-15", "qty_per_unit": 1.0},
        {"sku": "NAILS-ROOF", "qty_per_unit": 2.5},
        {"sku": "STARTR-STRIP", "qty_per_unit": 0.33},
        {"sku": "RIDGE-CAP", "qty_per_unit": 0.2}
    ]'::jsonb,
    '[
        {"task": "tear_off", "hours_per_unit": 0.75, "trade": "general"},
        {"task": "install", "hours_per_unit": 1.5, "trade": "skilled"}
    ]'::jsonb,
    '[
        {"type": "ladder_scaffolding", "cost_per_unit": 15.00},
        {"type": "debris_container", "cost_per_unit": 25.00}
    ]'::jsonb,
    1.10,
    350.00,  -- minimum charge for small roof repairs
    '[
        {"damage_type": "wind", "surface": "roof"},
        {"damage_type": "hail", "surface": "roof"},
        {"damage_type": "impact", "surface": "roof"}
    ]'::jsonb,
    ARRAY['ROOF-FELT-SYN', 'ROOF-FLASH-STEP', 'ROOF-VENT-RIDGE', 'DEM-HAUL']
);
```

### Materials to Add

For each new line item category, add corresponding materials with realistic base prices. Example:

```sql
INSERT INTO materials (sku, name, unit, base_price, price_source) VALUES
-- Roofing Materials
('SHNG-3TAB-BDL', '3-Tab shingles bundle', 'EA', 32.00, 'baseline_2024'),
('SHNG-ARCH-BDL', 'Architectural shingles bundle', 'EA', 42.00, 'baseline_2024'),
('FELT-15', 'Roofing felt 15#', 'ROLL', 22.00, 'baseline_2024'),
('FELT-SYN', 'Synthetic underlayment', 'ROLL', 85.00, 'baseline_2024'),
('NAILS-ROOF', 'Roofing nails 1.25"', 'LB', 3.50, 'baseline_2024'),
('STARTR-STRIP', 'Starter strip shingles', 'EA', 18.00, 'baseline_2024'),
('RIDGE-CAP', 'Ridge cap shingles', 'BDL', 55.00, 'baseline_2024'),
('FLASH-ALUM', 'Aluminum flashing roll', 'ROLL', 28.00, 'baseline_2024'),
('VENT-RIDGE', 'Ridge vent', 'LF', 4.50, 'baseline_2024'),
('VENT-BOX', 'Box vent', 'EA', 35.00, 'baseline_2024');
```

### Validation

After creating the seed files:

1. Ensure all category_id references exist
1. Ensure all material SKUs referenced in line items exist
1. Verify no duplicate codes
1. Run a test query to verify JSON is valid

Create a validation script: `db/seeds/99_validate_seeds.sql`

```sql
-- Check for orphaned category references
SELECT code, category_id FROM line_items 
WHERE category_id NOT IN (SELECT id FROM line_item_categories);

-- Check for missing material SKUs
-- (Would need a more complex query to parse JSONB)

-- Check for duplicate codes
SELECT code, COUNT(*) FROM line_items GROUP BY code HAVING COUNT(*) > 1;
```

## Success Criteria

- At least 150 new line items across all categories
- All necessary materials added
- All category hierarchies properly defined
- Realistic pricing that would be acceptable to insurance carriers
- Proper scope_triggers for AI-assisted scoping
- Related items linked for completeness checking

```
---

## Prompt 2: Build Estimate Generation

```markdown
# CLAUDE CODE TASK: Build Estimate Generation System

## Context
This is a property insurance claims estimation platform built with React frontend and Python/FastAPI backend. We need to build the estimate generation system that takes claim data (property, rooms, damage zones, line items) and produces professional PDF estimates that can be submitted to insurance carriers.

## Existing Data Model
We have these key tables:
- claims: Contains claim info, carrier, policy, date of loss
- properties: Address, property type, construction details
- stories: Floor levels of the property
- rooms: Room geometry, type, finishes
- damage_zones: Damage type, severity, affected areas, photos
- estimates: Version tracking, totals, status
- estimate_line_items: Individual priced items linked to damage zones

## Task Overview
Build the complete estimate generation pipeline:
1. Estimate calculation service
2. PDF generation with professional formatting
3. API endpoints for generation and retrieval
4. Frontend integration for preview and download

## Part 1: Estimate Calculation Service

Create `services/estimate_calculator.py`:

```python
"""
Estimate Calculator Service

Responsibilities:
1. Calculate line item prices based on region and carrier
2. Apply overhead and profit percentages
3. Calculate taxes
4. Generate estimate totals and breakdowns
5. Create estimate record with all line items
"""

from dataclasses import dataclass
from decimal import Decimal, ROUND_HALF_UP
from typing import Optional
from datetime import date
import json

@dataclass
class LineItemCalculation:
    line_item_id: str
    code: str
    description: str
    category_id: str
    damage_zone_id: Optional[str]
    quantity: Decimal
    unit: str
    unit_price: Decimal
    material_cost: Decimal
    labor_cost: Decimal
    equipment_cost: Decimal
    subtotal: Decimal
    source: str  # 'auto_suggested', 'manual', 'ai_recommended'

@dataclass
class EstimateCalculation:
    claim_id: str
    line_items: list[LineItemCalculation]
    subtotal: Decimal
    overhead_pct: Decimal
    overhead_amount: Decimal
    profit_pct: Decimal
    profit_amount: Decimal
    tax_pct: Decimal
    tax_amount: Decimal
    grand_total: Decimal
    pricing_date: date
    region_id: str
    carrier_id: Optional[str]

class EstimateCalculator:
    """
    Calculates complete estimates from claim data.
    
    Usage:
        calculator = EstimateCalculator(db)
        estimate = await calculator.calculate(
            claim_id="...",
            overhead_pct=0.10,
            profit_pct=0.10
        )
        estimate_id = await calculator.save(estimate)
    """
    
    def __init__(self, db_connection):
        self.db = db_connection
    
    async def calculate(
        self,
        claim_id: str,
        overhead_pct: Decimal = Decimal("0.10"),
        profit_pct: Decimal = Decimal("0.10"),
        carrier_id: Optional[str] = None
    ) -> EstimateCalculation:
        """Calculate complete estimate for a claim."""
        # Implementation here...
        pass
    
    async def save(self, calculation: EstimateCalculation) -> str:
        """Save calculation as estimate record."""
        # Implementation here...
        pass
    
    async def _get_claim_line_items(self, claim_id: str) -> list[dict]:
        """Get all line items for a claim from damage zones."""
        pass
    
    async def _calculate_line_item_price(
        self, 
        line_item_code: str,
        quantity: Decimal,
        region_id: str,
        carrier_id: Optional[str]
    ) -> LineItemCalculation:
        """Calculate price for single line item."""
        pass
```

Implement the full calculator with:

- Regional pricing lookup
- Carrier adjustment application
- Material/labor/equipment breakdown
- Minimum charge enforcement
- Waste factor application

## Part 2: PDF Generation Service

Create `services/pdf_generator.py`:

Use ReportLab or WeasyPrint to generate professional PDFs.

### PDF Layout Requirements

**Page 1: Cover/Summary**

- Company logo area (Claims IQ branding)
- Estimate number and date
- Claim information box:
  - Claim #, Policy #, Date of Loss
  - Carrier name
  - Insured name (from claim data)
- Property information box:
  - Full address
  - Property type, year built, sqft
- Estimate summary:
  - Total line items count
  - Subtotal
  - O&P
  - Tax
  - **Grand Total** (prominent)
- Prepared by / contact info

**Page 2+: Detailed Estimate**

- Header on each page:
  - Estimate #, Claim #, Page X of Y
  - Property address (abbreviated)
- Line items grouped by category:

```
┌────────────────────────────────────────────────────────────────────────┐
│ 03 - WATER MITIGATION                                                  │
├──────┬────────────────────────────────────┬──────┬──────┬──────┬───────┤
│ Code │ Description                        │ Qty  │ Unit │ Rate │ Total │
├──────┼────────────────────────────────────┼──────┼──────┼──────┼───────┤
│WTR-  │Water extraction - carpet/pad       │ 450  │ SF   │ 0.85 │385.00 │
│EXT-01│                                    │      │      │      │       │
├──────┼────────────────────────────────────┼──────┼──────┼──────┼───────┤
│WTR-  │Air mover - per unit per day        │ 12   │ EA   │45.00 │540.00 │
│AIR-MV│  (4 units × 3 days)                │      │      │      │       │
├──────┼────────────────────────────────────┼──────┼──────┼──────┼───────┤
│      │                    Category Total: │      │      │      │925.00 │
└──────┴────────────────────────────────────┴──────┴──────┴──────┴───────┘
```

- Category subtotals
- Running page totals

**Final Page: Totals & Certification**

- Summary by category (mini table)
- Calculation breakdown:
  - Subtotal
  - Overhead (X%)
  - Profit (X%)
  - Subtotal with O&P
  - Tax (X%)
  - **Grand Total**
- Signature/certification area
- Terms and conditions (small print)
- Footer with generation timestamp

**Photo Documentation Section (Optional)**

- Thumbnail grid of damage photos
- Captions with room/damage zone reference
- Page break before this section

### PDF Styling

```python
# Color scheme
COLORS = {
    'primary': '#1e3a5f',      # Deep blue - headers
    'secondary': '#0d9488',    # Teal - accents
    'text': '#1f2937',         # Dark gray - body text
    'light_gray': '#f3f4f6',   # Row alternating
    'border': '#d1d5db',       # Table borders
    'total_bg': '#e0f2fe',     # Total row background
}

# Fonts
FONTS = {
    'heading': ('Helvetica-Bold', 14),
    'subheading': ('Helvetica-Bold', 11),
    'body': ('Helvetica', 9),
    'small': ('Helvetica', 8),
    'total': ('Helvetica-Bold', 10),
}
```

### PDF Generator Class

```python
class EstimatePDFGenerator:
    """
    Generates professional PDF estimates.
    
    Usage:
        generator = EstimatePDFGenerator()
        pdf_bytes = await generator.generate(estimate_id, db)
        
        # Save to file
        with open('estimate.pdf', 'wb') as f:
            f.write(pdf_bytes)
        
        # Or upload to S3/storage
        url = await storage.upload(pdf_bytes, f"estimates/{estimate_id}.pdf")
    """
    
    def __init__(self, logo_path: str = None):
        self.logo_path = logo_path
    
    async def generate(self, estimate_id: str, db) -> bytes:
        """Generate PDF for estimate."""
        pass
    
    def _build_cover_page(self, canvas, estimate_data: dict):
        """Build the cover/summary page."""
        pass
    
    def _build_line_items_pages(self, canvas, line_items: list):
        """Build detailed line item pages."""
        pass
    
    def _build_totals_page(self, canvas, estimate_data: dict):
        """Build final totals and certification page."""
        pass
    
    def _build_photo_pages(self, canvas, photos: list):
        """Build photo documentation pages."""
        pass
```

## Part 3: API Endpoints

Add to `api/routes/estimates.py`:

```python
from fastapi import APIRouter, HTTPException, Depends, BackgroundTasks
from fastapi.responses import StreamingResponse
from pydantic import BaseModel
from typing import Optional
from decimal import Decimal
import io

router = APIRouter(prefix="/api/estimates", tags=["estimates"])

class GenerateEstimateRequest(BaseModel):
    claim_id: str
    overhead_pct: float = 0.10
    profit_pct: float = 0.10
    include_photos: bool = True
    carrier_id: Optional[str] = None

class EstimateResponse(BaseModel):
    id: str
    claim_id: str
    version: int
    status: str
    subtotal: float
    overhead_amount: float
    profit_amount: float
    tax_amount: float
    grand_total: float
    line_item_count: int
    created_at: str
    pdf_url: Optional[str]

@router.post("/generate", response_model=EstimateResponse)
async def generate_estimate(
    request: GenerateEstimateRequest,
    background_tasks: BackgroundTasks,
    db = Depends(get_db)
):
    """
    Generate a new estimate for a claim.
    
    This calculates all line items, applies pricing, and creates
    the estimate record. PDF generation happens in background.
    """
    pass

@router.get("/{estimate_id}", response_model=EstimateResponse)
async def get_estimate(estimate_id: str, db = Depends(get_db)):
    """Get estimate details."""
    pass

@router.get("/{estimate_id}/pdf")
async def download_estimate_pdf(estimate_id: str, db = Depends(get_db)):
    """
    Download estimate as PDF.
    
    Returns streaming PDF response for direct download.
    """
    generator = EstimatePDFGenerator()
    pdf_bytes = await generator.generate(estimate_id, db)
    
    return StreamingResponse(
        io.BytesIO(pdf_bytes),
        media_type="application/pdf",
        headers={
            "Content-Disposition": f"attachment; filename=estimate_{estimate_id}.pdf"
        }
    )

@router.get("/{estimate_id}/preview")
async def preview_estimate_pdf(estimate_id: str, db = Depends(get_db)):
    """
    Preview estimate PDF in browser.
    
    Returns PDF for inline viewing (no download prompt).
    """
    generator = EstimatePDFGenerator()
    pdf_bytes = await generator.generate(estimate_id, db)
    
    return StreamingResponse(
        io.BytesIO(pdf_bytes),
        media_type="application/pdf",
        headers={
            "Content-Disposition": f"inline; filename=estimate_{estimate_id}.pdf"
        }
    )

@router.get("/claim/{claim_id}")
async def get_estimates_for_claim(claim_id: str, db = Depends(get_db)):
    """Get all estimate versions for a claim."""
    pass

@router.post("/{estimate_id}/finalize")
async def finalize_estimate(estimate_id: str, db = Depends(get_db)):
    """
    Finalize estimate - locks it from further changes.
    
    This should be called before submission to carrier.
    """
    pass
```

## Part 4: Frontend Integration

Create/update these React components:

### EstimatePreview Component

`src/components/EstimatePreview.tsx`

```typescript
interface EstimatePreviewProps {
  claimId: string;
  onGenerate?: (estimateId: string) => void;
}

/**
 * Component for generating and previewing estimates.
 * 
 * Features:
 * - Generate new estimate button
 * - Estimate summary display
 * - Embedded PDF preview
 * - Download button
 * - Version history
 */
export function EstimatePreview({ claimId, onGenerate }: EstimatePreviewProps) {
  // State for estimate data, loading, PDF URL
  // Generate estimate handler
  // PDF embed/preview
  // Download handler
}
```

### EstimateSummary Component

`src/components/EstimateSummary.tsx`

```typescript
interface EstimateSummaryProps {
  estimate: {
    subtotal: number;
    overhead_pct: number;
    overhead_amount: number;
    profit_pct: number;
    profit_amount: number;
    tax_amount: number;
    grand_total: number;
    line_item_count: number;
    categories: {
      id: string;
      name: string;
      total: number;
    }[];
  };
  editable?: boolean;
  onOverheadChange?: (pct: number) => void;
  onProfitChange?: (pct: number) => void;
}

/**
 * Displays estimate totals with optional editing of O&P.
 */
export function EstimateSummary({ estimate, editable, ...props }: EstimateSummaryProps) {
  // Category breakdown mini-chart
  // Editable O&P percentages
  // Calculated totals display
}
```

### API Integration

`src/api/estimates.ts`

```typescript
export const estimatesApi = {
  generate: async (claimId: string, options?: {
    overhead_pct?: number;
    profit_pct?: number;
    include_photos?: boolean;
  }) => {
    const response = await fetch('/api/estimates/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ claim_id: claimId, ...options })
    });
    return response.json();
  },
  
  get: async (estimateId: string) => {
    const response = await fetch(`/api/estimates/${estimateId}`);
    return response.json();
  },
  
  getPdfUrl: (estimateId: string) => `/api/estimates/${estimateId}/pdf`,
  
  getPreviewUrl: (estimateId: string) => `/api/estimates/${estimateId}/preview`,
  
  getForClaim: async (claimId: string) => {
    const response = await fetch(`/api/estimates/claim/${claimId}`);
    return response.json();
  },
  
  finalize: async (estimateId: string) => {
    const response = await fetch(`/api/estimates/${estimateId}/finalize`, {
      method: 'POST'
    });
    return response.json();
  }
};
```

## Part 5: Data Queries

Create `services/estimate_queries.py` with optimized queries:

```python
"""
Estimate-related database queries.
"""

# Get complete estimate data for PDF generation
ESTIMATE_FULL_QUERY = """
SELECT 
    e.*,
    c.claim_number,
    c.policy_number,
    c.date_of_loss,
    c.claim_type,
    cp.carrier_name,
    p.street_address,
    p.city,
    p.state_province,
    p.postal_code,
    p.property_type,
    p.year_built,
    p.total_sqft
FROM estimates e
JOIN claims c ON e.claim_id = c.id
LEFT JOIN carrier_profiles cp ON c.carrier_id = cp.id
JOIN properties p ON p.claim_id = c.id
WHERE e.id = $1
"""

# Get line items grouped by category
LINE_ITEMS_BY_CATEGORY_QUERY = """
SELECT 
    eli.*,
    lic.name as category_name,
    lic.parent_id as parent_category_id,
    plic.name as parent_category_name,
    dz.room_id,
    r.name as room_name
FROM estimate_line_items eli
JOIN line_item_categories lic ON eli.category_id = lic.id
LEFT JOIN line_item_categories plic ON lic.parent_id = plic.id
LEFT JOIN damage_zones dz ON eli.damage_zone_id = dz.id
LEFT JOIN rooms r ON dz.room_id = r.id
WHERE eli.estimate_id = $1
ORDER BY lic.sort_order, eli.sort_order
"""

# Get category totals
CATEGORY_TOTALS_QUERY = """
SELECT 
    COALESCE(lic.parent_id, eli.category_id) as category_id,
    COALESCE(plic.name, lic.name) as category_name,
    SUM(eli.subtotal) as total
FROM estimate_line_items eli
JOIN line_item_categories lic ON eli.category_id = lic.id
LEFT JOIN line_item_categories plic ON lic.parent_id = plic.id
WHERE eli.estimate_id = $1
GROUP BY COALESCE(lic.parent_id, eli.category_id), COALESCE(plic.name, lic.name)
ORDER BY category_id
"""

# Get photos for estimate
ESTIMATE_PHOTOS_QUERY = """
SELECT 
    dzp.*,
    dz.damage_type,
    r.name as room_name
FROM damage_zone_photos dzp
JOIN damage_zones dz ON dzp.damage_zone_id = dz.id
JOIN rooms r ON dz.room_id = r.id
JOIN stories s ON r.story_id = s.id
JOIN properties p ON s.property_id = p.id
JOIN claims c ON p.claim_id = c.id
JOIN estimates e ON e.claim_id = c.id
WHERE e.id = $1
ORDER BY r.name, dzp.created_at
"""
```

## File Structure

Create these files:

```
services/
├── estimate_calculator.py
├── estimate_queries.py
├── pdf_generator.py
└── pdf_templates/
    ├── styles.py
    ├── cover_page.py
    ├── line_items_page.py
    ├── totals_page.py
    └── photo_page.py

api/routes/
└── estimates.py

src/
├── api/
│   └── estimates.ts
├── components/
│   ├── EstimatePreview.tsx
│   ├── EstimateSummary.tsx
│   └── EstimateLineItems.tsx
└── pages/
    └── ClaimDetail.tsx (update to include estimate tab)
```

## Testing

Create test file `tests/test_estimate_generation.py`:

```python
import pytest
from decimal import Decimal

@pytest.mark.asyncio
async def test_estimate_calculation():
    """Test that estimate calculates correctly."""
    # Create test claim with known line items
    # Calculate estimate
    # Assert totals are correct
    pass

@pytest.mark.asyncio
async def test_pdf_generation():
    """Test that PDF generates without errors."""
    # Generate PDF for test estimate
    # Assert PDF bytes are valid
    # Assert PDF has correct page count
    pass

@pytest.mark.asyncio  
async def test_overhead_profit_calculation():
    """Test O&P calculations."""
    # Test various O&P percentages
    # Verify math is correct
    pass

@pytest.mark.asyncio
async def test_regional_pricing():
    """Test that regional pricing adjustments apply."""
    # Same line items, different regions
    # Verify price differences
    pass
```

## Success Criteria

1. **Calculation Accuracy**

- Line item prices match expected based on components
- O&P calculates correctly on subtotal
- Tax applies to correct base
- Grand total is accurate

1. **PDF Quality**

- Professional appearance suitable for carrier submission
- All data renders correctly
- No layout overflow issues
- Photos display properly if included

1. **Performance**

- Estimate calculation < 2 seconds
- PDF generation < 5 seconds
- API responses < 500ms

1. **Integration**

- Frontend can generate estimates
- PDF preview works in browser
- Download works correctly
- Version history displays

## Dependencies to Add

```
# requirements.txt additions
reportlab>=4.0.0
Pillow>=10.0.0
```

or alternatively:

```
weasyprint>=60.0
```

```
---

## How to Use These Prompts

1. **Open Claude Code** in your terminal connected to your Replit repo

2. **For Line Items expansion:**
   ```bash
   claude
```

Then paste Prompt 1 and let Claude Code create all the seed files

1. **For Estimate Generation:**
   
   ```bash
   claude
   ```
   
   Then paste Prompt 2 and Claude Code will build the complete estimate system
1. **Run the seeds** after Claude Code creates them:
   
   ```bash
   psql $DATABASE_URL -f db/seeds/02_categories_expanded.sql
   # ... etc for each file
   ```

-----

Want me to also create prompts for:

- **ESX Export** (Xactimate compatibility)
- **AI Scope Suggestions** (damage → line item recommendations)
- **Photo AI Analysis** (damage detection from uploaded photos)