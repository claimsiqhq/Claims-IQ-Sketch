# Claims IQ Sketch — Full Application Spec (Fresh Swift/iOS Build)

This document describes the **entire application end-to-end** for building a **new** native iOS app in Xcode from scratch. It is not a migration guide. The app is for **insurance field adjusters** doing **property inspections**: FNOL intake, guided inspection flows, evidence capture (photos, voice, sketches), **LiDAR room scanning**, scope/estimates, and documents. Use this as the single source of truth for product behavior, data model, and technical direction.

---

## 1. Product overview

- **Name:** Claims IQ Sketch (iOS).
- **Users:** Field adjusters (insurance) at the property.
- **Goal:** Streamline property inspections: see claim context (FNOL, policy), run a guided inspection (phases/movements), capture evidence (photos, voice, sketches, **LiDAR room measurements**), build scope and estimates, and stay usable offline.
- **Platform:** iOS only. Swift, Xcode. Target iOS 16+ (LiDAR: iPhone Pro 12+, iPad Pro with LiDAR). Prefer **SwiftUI**; use UIKit where necessary (camera, AR, complex tables).
- **New capability:** **LiDAR scanning** for room dimensions and geometry that feed **scope** and **sketches** (see §10).

---

## 2. Core entities (canonical names)

Use these names consistently in code and UI:

- **Claim** — A single insurance claim (policyholder, address, date of loss, peril, status).
- **FNOL** — First Notice of Loss; loss description, reported damage, contact info.
- **Flow** — One inspection flow instance for a claim (e.g. “Standard wind/hail inspection”). Has phases and movements.
- **Flow definition** — Template for a flow (phases, movements, validation rules).
- **Phase** — Group of movements (e.g. Arrival, Exterior Documentation, Interior Documentation).
- **Movement** — One atomic inspection task (e.g. “Document north elevation”). User completes movements by adding evidence and marking complete.
- **Evidence** — Item attached to a movement or claim: **photo**, **voice note**, **sketch reference**, **measurement** (including from LiDAR).
- **Document** — Uploaded file (FNOL, policy, endorsement, etc.); classified and optionally extracted.
- **Photo** — Claim/movement photo; can have AI analysis (quality, damage, concerns).
- **Sketch** — Floor plan: structures, rooms, openings, damage zones; can be voice-guided or manual (and LiDAR-assisted).
- **Scope** — Line items and quantities for repair (e.g. Xactimate-style); ties to zones/rooms.
- **Estimate** — Hierarchical estimate (structures → areas → zones/rooms → line items); pricing and totals.
- **Room / Zone** — A room or zone in a sketch or scope; can have dimensions (manual or from LiDAR).

---

## 3. Claim lifecycle and status

- **Status values:** `draft` | `fnol` | `open` | `in_progress` | `review` | `approved` | `closed`.
- **Flow:** New claim often starts as `fnol` (intake). Moving to inspection → `open` or `in_progress`. When inspection/estimate work is done → `review` → `approved` or `closed`. `closed` implies a closed date.
- **Timing:** Track “open since” / “closed after” and, for the active flow, “inspection started” / “inspection completed” for display (e.g. master claim timer).

---

## 4. Main screens and navigation

- **Dashboard / My Day** — List or map of claims for the day; optional calendar and route optimization. Quick access to “today’s inspections.”
- **Claim list** — Filterable/searchable list of claims (e.g. by status, date, policyholder).
- **Claim detail** — Central hub for one claim. Key areas:
  - **Header:** Policyholder, claim ID, status badge, peril(s), master timer (open/closed and inspection timing).
  - **Tabs (or equivalent):** Info (FNOL + weather + tips), Inspection Flow, Photos, Documents, Sketch, Estimate/Scope, etc.
- **Info tab** — FNOL summary: policyholder, address, date of loss, peril/cause of loss, **loss description** (single place; do not duplicate in a second “loss description” block). **Weather on date of loss** (temperature, conditions, wind, precip, etc.) near the top (e.g. between inspection tips and FNOL details). Peril-specific **inspection tips**. Carrier-specific **guidance** (read-only). Optional: insured info, policy summary.
- **Inspection Flow** — Shows active flow for the claim: phases, movements, progress (e.g. X/Y movements, % complete). Actions: “Start flow” (if none), “Resume” / open flow to run movements.
- **Flow execution** — List of phases and movements; user taps a movement to open **movement execution**.
- **Movement execution** — Single movement: name, description, evidence requirements (photos, voice, measurements). Capture: **photos** (camera), **voice notes** (record, then save/discard), **sketch** (link to sketch or capture inline). Show **existing evidence** (e.g. grid) with **photo analysis badges** (Analyzing / Needs rework / Analysis failed / OK) so rework is visible without leaving the step. “Complete” marks the movement done (with validation if required).
- **Photos** — Claim-level photo album; filter by flow/movement/room. **Photo detail:** analysis status, quality score, damage detected, description, issues/suggestions, re-analyze when failed/concerns.
- **Documents** — List of documents; upload; classify (FNOL, policy, endorsement, etc.); viewer with previews.
- **Sketch** — Floor plan: structures (e.g. main house, garage), **rooms** (dimensions, shape, openings, features, damage zones). Support **voice-guided** creation (“Add a 12x15 kitchen”) and **manual** editing. **LiDAR:** optional pre-fill or suggest room shapes/dimensions from scans. Save/load per claim.
- **Estimate / Scope** — Hierarchical view: structures → areas → zones (rooms) → **line items** (with quantities, pricing). Voice scope: “Add 180 sq ft drywall replacement” → search line items, add to estimate. **LiDAR** room dimensions feed quantities (e.g. area). Export (e.g. ESX) if required.

---

## 5. Inspection flow (phases and movements)

- **Model:** One **flow** per claim (from a **flow definition**). Flow has **phases**; each phase has **movements**. User completes **movements** (order can be flexible); progress = completed movements / total.
- **Phases (canonical):** Arrival → Orientation → Exterior Documentation → Interior Documentation → Synthesis → Departure. Phases are guides, not strict gates; user can jump between movements.
- **Movement:** Has name, description, optional **evidence requirements** (e.g. “At least 2 photos”, “Voice note or note”). Required vs optional. Validation can block completion until requirements are met (and, if applicable, photo analysis is acceptable).
- **Evidence attachment:** Photos and voice notes (and optionally sketch refs) are attached to a **movement**. Store `flow_instance_id`, `movement_id`, `evidence_type`, `reference_id` (e.g. photo ID). When displaying “Previously Captured” on movement execution, show **photo analysis status** (Analyzing / Needs rework / Analysis failed / OK) on each photo so rework is visible in-context.
- **Completion:** “Complete movement” sends completion (and any new evidence). Offline: queue completion and evidence; sync when online.
- **Flow progress API:** Need at least: total movements, completed count, percent complete; optional: per-phase breakdown. Use for “X / Y movements, Z% complete” on claim detail and flow execution.

---

## 6. FNOL and claim info

- **FNOL:** First Notice of Loss data — date of loss, peril/cause of loss, property address, policyholder, **loss description**, reported damage, contact info. Single **loss description** block on claim detail; no duplicate “second” loss description box.
- **Weather on date of loss:** If available, show near top of info (between inspection tips and FNOL details): temp, conditions, wind, precip, hail size if relevant; label with date of loss.
- **Inspection tips:** Peril-specific (e.g. wind/hail, water). Collapsible panel.
- **Carrier guidance:** Read-only, carrier-specific requirements. Optional panel.
- **Peril:** Primary (and optional secondary) peril; drives tips, flow templates, and validation.

---

## 7. Documents

- **Upload:** User uploads documents (e.g. PDF) to the claim.
- **Classification:** Each document has a type: e.g. **FNOL**, **policy**, **endorsement**, photo, estimate, correspondence.
- **Extraction:** Backend (or client) can extract structured data (FNOL fields, policy limits, endorsements) and merge into claim context. App displays extracted summary where relevant.
- **Viewer:** Open document with page previews; support PDF and common formats. Optional: “document previews” generated on demand (e.g. PNG per page).

---

## 8. Photos and photo analysis

- **Capture:** From camera; attach to claim and optionally to flow/movement/room. Store with hierarchy path (e.g. “Flow / Inspection / North elevation”).
- **Upload:** Upload to backend; store URL and metadata. Offline: queue; upload and attach when online.
- **Analysis (backend):** After upload, server runs **AI vision analysis** (async): quality score (e.g. 1–10), description, damage detected, damage types, materials, **quality issues**, **suggestions**, **concerns** (e.g. staging). Store `analysis_status`: `pending` | `analyzing` | `completed` | `concerns` | `failed`; and `analysis_error` / quality fields.
- **In UI:** In **photo album** (claim photos tab / photos page): card shows badge (Analyzing / Needs rework / OK / Failed); detail view shows full analysis and “Re-analyze” when failed or concerns. On **movement execution**, “Previously Captured” evidence grid must show the **same status badges** on each photo so adjusters see “needs rework” without opening the gallery. Poll or refetch while any photo is pending/analyzing so badges update in place.
- **Rework:** “Needs rework” = `concerns` (or low quality); “Analysis failed” = `failed`. User can retake photo or re-analyze.

---

## 9. Voice notes and audio

- **Capture:** Record audio on movement execution; save or discard. Show recording timer; handle MediaRecorder (or native AVAudioRecorder) and mime types across devices.
- **Upload:** Upload file; attach to movement as voice note evidence. Offline: queue recording; upload and attach when online. Timeout (e.g. 90s) for upload to avoid indefinite hang.
- **Transcription/processing:** Optional server-side (e.g. Whisper); app displays “Voice note” in evidence list and may show transcript when available.

---

## 10. Sketches

- **Purpose:** Floor plans for the property: structures, rooms, openings (doors, windows), features (closets, islands), damage zones.
- **Structures:** E.g. main dwelling, garage, shed. Each has a list of rooms.
- **Rooms:** Dimensions (width, length, ceiling height), shape (rectangle, L-shape, etc.), position. **Openings** on walls (type, size, position). **Features** and **notes**. **Damage zones** with severity (e.g. minor/moderate/severe/total).
- **Creation:** **Voice-guided** (“Add a 12 by 15 foot kitchen”, “Add a 3 foot door on the north wall”) and/or **manual** (toolbar: add room, add opening, mark damage, etc.). **LiDAR:** Use scanned room dimensions and boundaries to **pre-fill or suggest** room shapes and sizes so sketches match real measurements.
- **Persistence:** Save/load per claim. Map to backend: e.g. `claim_rooms`, `claim_structures`, `zone_openings`, damage zones. Load saved rooms when opening claim; show “Loaded X rooms” feedback.
- **Units:** Feet/inches (US); optional metric. Store consistently.

---

## 11. Scope and estimates

- **Structure:** Estimate = hierarchy: **structures** (e.g. main house, garage) → **areas** (e.g. first floor, second floor) → **zones/rooms** → **line items** (with quantity, unit, price). Optional coverages (Coverage A, B, etc.).
- **Line items:** Repairs (e.g. drywall, roofing, paint); from catalog (e.g. Xactimate-style). Quantities from manual entry, **voice scope** (“Replace 200 sq ft drywall”), or **LiDAR** (room area → sq ft for flooring/drywall).
- **Voice scope:** User says “Add 180 sq ft drywall replacement”; app or backend searches line items, adds to estimate with quantity. Claim context (briefing, peril, workflow) can guide suggestions.
- **LiDAR:** Room dimensions (length, width, height, area) from scanning → suggest or auto-fill quantities for scope (e.g. floor area for flooring, wall area for drywall).
- **Export:** Optional ESX (or similar) for downstream systems.

---

## 12. LiDAR and room scanning (new)

- **Purpose:** Capture real-world room dimensions and geometry to **assist scope and sketches** (no migration from existing app).
- **APIs:** **RoomPlan** (iOS 16+) for room-level geometry; **ARKit** (scene reconstruction, LiDAR) when you need meshes or custom capture. Prefer RoomPlan for “room dimensions + boundaries”; ARKit for raw data.
- **Flow:** User enters a room → start scan → guide (“Move slowly around the room”) → live feedback → finish → show/edit dimensions (length, width, height, area) → **commit to scope** (e.g. as zone dimensions) and/or **to sketch** (pre-fill or suggest room shape).
- **Data:** Persist dimensions with units; link to claim and optionally to room/zone/structure. Sync to backend if present.
- **Device:** Require LiDAR for scan feature; check `ARWorldTrackingConfiguration.supportsSceneReconstruction(.mesh)` (or equivalent). On non‑LiDAR devices: hide or disable scan; offer manual dimension entry only.
- **UX:** Clear instructions, confidence indicator, confirm/edit step before applying to scope or sketch.

---

## 13. Offline and sync

- **Detection:** Use network state (e.g. NWPathMonitor) to treat app as online or offline.
- **When offline:** Cache claim and flow data needed for current work. **Queue:** New evidence (photos, voice, LiDAR result blobs if any), movement completions, and optionally sketch/scope updates. Do not block user from continuing the inspection.
- **When online:** **Sync:** Upload queued evidence, attach to movements, send completions, then update local state. Retry failed sync; surface errors. Conflict handling: define policy (e.g. last-write-wins for scope or explicit merge).
- **Evidence:** Each queued item should store enough context (claimId, flowId, movementId, userId) so after upload the server can attach evidence correctly.

---

## 14. Backend (optional)

- If you build or reuse a REST backend, align with these concepts:
  - **Claims:** CRUD; status; FNOL/extracted fields; weather on DoL.
  - **Flows:** Get/create flow for claim; get flow with phases/movements; progress (total, completed, percent).
  - **Movements:** Complete movement (payload + evidence refs); get evidence for movement (including photo `analysis_status`, `analysis_error`, `quality_score`).
  - **Evidence:** Upload photo/audio; attach to movement (type, referenceId, userId). Get movement evidence returns photo analysis fields for in-workflow badges.
  - **Documents:** Upload, classify, list, download, preview URL.
  - **Sketch:** Save/load rooms (and structures, openings, damage zones) per claim.
  - **Estimate/Scope:** Line items, quantities, hierarchy; optional export.
- Auth: Support authenticated requests (e.g. bearer token); multi-tenant by organization if needed.

---

## 15. Code and architecture (Swift)

- **Project:** Fresh Xcode project; Swift Package Manager for dependencies. iOS 16+; SwiftUI preferred; UIKit where needed (camera, AR, complex lists).
- **Structure:** Feature-based: e.g. `Claims/`, `Flows/`, `Evidence/`, `Photos/`, `Documents/`, `Sketch/`, `Scope/`, `LiDAR/` or `Scanning/`. Within each: views, view models, models, services. Clear separation: UI, domain models, network/persistence.
- **Naming:** Follow Swift API design guidelines; use canonical entity names (Claim, Flow, Movement, Evidence, etc.).
- **Concurrency:** async/await; `@MainActor` for UI updates. No callback pyramids.
- **Models:** Prefer value types (structs) for domain models; classes only where reference semantics or delegates are required (e.g. AR session).
- **Errors:** Use `Result` or typed errors; avoid silent failures in upload, sync, and LiDAR.
- **Testing:** Unit tests for conversions (units, dimensions), scope logic, sketch geometry. UI tests for: open claim, start flow, complete movement with photo, view photo rework badge. **Mock LiDAR/AR** in tests (no real device required).
- **Accessibility:** VoiceOver labels for camera, AR, and scanning; Dynamic Type; high contrast where applicable.
- **Localization:** At least English; externalize all user-facing strings from the start.

---

## 16. Summary checklist (what the app must do)

- [ ] Claim list and detail; claim status and master timer.
- [ ] FNOL info: single loss description; weather on DoL near top; inspection tips; carrier guidance.
- [ ] Inspection flow: phases and movements; progress (X/Y, %); movement execution with evidence capture (photo, voice, sketch ref).
- [ ] Photo analysis visible in workflow: badges (Analyzing / Needs rework / Failed / OK) on movement evidence; photo album with full analysis and re-analyze.
- [ ] Documents: upload, classify, view.
- [ ] Sketch: structures, rooms, openings, damage zones; voice and/or manual; save/load; **LiDAR** can pre-fill or suggest room dimensions.
- [ ] Scope/estimate: hierarchy, line items, quantities; voice scope; **LiDAR** dimensions feed quantities.
- [ ] **LiDAR:** Room scan → dimensions → scope and sketch; gated on device; graceful fallback (manual entry).
- [ ] Offline: queue evidence and completions; sync when online.
- [ ] Swift/SwiftUI, iOS 16+, Xcode, SPM; feature-based layout; async/await; tests and accessibility.

This file fully describes the application end-to-end for a **fresh** Swift build in Xcode (no migration). Use it as the single source of truth for behavior and scope.
